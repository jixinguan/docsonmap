2018-01-28
2017-11-03:
    var mapboxUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'
    var mapboxAttribution = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'
    var myToken = 'pk.eyJ1Ijoiaml4aW4tZ3VhbiIsImEiOiJjajRzd2NidWowMXpkMnFwaDRmaXk0MzU3In0.1B6QeB7yLSjKo2e1-IsAgw'
    
    // three base layers
    var grayscale = L.tileLayer(mapboxUrl, 
        {
        id: 'mapbox.light', 
        attribution: mapboxAttribution,
        accessToken: myToken
      }),
      satellite = L.tileLayer(mapboxUrl, {
        id: 'mapbox.satellite', 
        attribution: mapboxAttribution,
        accessToken: myToken
      }),
      streets   = L.tileLayer(mapboxUrl, {
        id: 'mapbox.streets', 
        attribution: mapboxAttribution,
        accessToken: myToken
      });
            
      // initialize the map
      var map = L.map('map', {
            zoomSnap: 0.1,
            center: [53.554121, -113.491433], 
            zoom:12,
            layers: [streets]
        });      
        
      // create a objects to contain base layers 
      var baseMaps = {
        "<span style='color: blue'>Grayscale</span>": grayscale,
        "Satellite": satellite,
        "Streets": streets
      };

      // create layer Control to show/hide 
      L.control.layers(baseMaps).addTo(map);

      function addDataToMap(data){
        alert("addDataToMap!");
        var dataLayer = L.geoJSON(data);
        dataLayer.addTo(map);
      }

      $.getJSON("example.geojson", function(data) {
        alert("success");
      })
      .success(function(data) { 
        alert("Second success");
        console.log(data);
        addDataToMap(data); })
      .error(function() { alert("error"); })
      .complete(function() { alert("complete"); });

Working request for json:      
http://172.23.37.69:8080/geoserver/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=mappoint&srsName=EPSG:4269&outputFormat=json
-------------------------------------------------------------- successfully load from wfs service! ----------------
<html>
        <head>
          <title>GeoServer WMS API Caller</title>
          <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
            integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
            crossorigin=""/>

          <!-- Make sure you put this AFTER Leaflet's CSS -->
          <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
            integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
            crossorigin=""></script>
    
          <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
          <link rel="stylesheet" href="JixinCustomize.css" />
          
          <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
        </head>
        <body>
          <div id="map"></div>
          <div id="test"> <button type="button" id = "loaddata">Load</button> <p id="testp">TEST</p>
          <script>
            //$.noConflict();
    var mapboxUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}'
    var mapboxAttribution = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'
    var myToken = 'pk.eyJ1Ijoiaml4aW4tZ3VhbiIsImEiOiJjajRzd2NidWowMXpkMnFwaDRmaXk0MzU3In0.1B6QeB7yLSjKo2e1-IsAgw'
    
    // three base layers
    var grayscale = L.tileLayer(mapboxUrl, 
        {
        id: 'mapbox.light', 
        attribution: mapboxAttribution,
        accessToken: myToken
      }),
      satellite = L.tileLayer(mapboxUrl, {
        id: 'mapbox.satellite', 
        attribution: mapboxAttribution,
        accessToken: myToken
      }),
      streets   = L.tileLayer(mapboxUrl, {
        id: 'mapbox.streets', 
        attribution: mapboxAttribution,
        accessToken: myToken
      });
            
      // initialize the map
      var map = L.map('map', {
            zoomSnap: 0.1,
            center: [53.554121, -113.491433], 
            zoom: 11,
            layers: [streets]
        });      
        
      // create a objects to contain base layers 
      var baseMaps = {
        "<span style='color: blue'>Grayscale</span>": grayscale,
        "Satellite": satellite,
        "Streets": streets
      };

/*
      // create layer Control to show/hide 
      L.control.layers(baseMaps).addTo(map);

      function addDataToMap(data){
        alert("addDataToMap!");
        var dataLayer = L.geoJSON(data);
        dataLayer.addTo(map);
      }

      $.getJSON("example.geojson", function(data) {
        alert("success");
      })
      .success(function(data) { 
        alert("Second success");
        console.log(data);
        addDataToMap(data); })
      .error(function() { alert("error"); })
      .complete(function() { alert("complete"); });
*/

    //var geojsonLayer = L.geoJSON();
    
     function loadGeoJson(data) { 
       console.log(data);
        //geojson.addGeoJSON(data); 
    }

    //var geoJsonUrl = "http://172.23.37.69:8080/geoserver/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=mappoint&srsName=EPSG:4269&outputFormat=json&format_options=callback:loadGeoJson"; 
    //$.ajax({ 
    //    url: geoJsonUrl, 
    //    dataType: 'json'
    //});   
    //map.addLayer(geojsonLayer);

/*
    $.ajax({
      url: 'http://172.23.37.69:8080/geoserver/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=mappoint:mappoint&srsName=EPSG:4269',
      dataType: 'JSONP',
      jsonpCallback: 'callback',
      type: 'GET',
      success: function (data) {
        console.log(data);
      }
    });


    var rootUrl = 'http://172.23.37.69:8080/geoserver/ows';
    var defaultParameters = {
      service: 'WFS',
      version: '1.1.0',
      request: 'GetFeature',
      typeName: 'mappoint:mappoint',
      maxFeatures: 10,
      outputFormat: 'text/javascript',
      format_options: 'callback: getJson'
    };
    
    var parameters = L.Util.extend(defaultParameters);

    $.ajax({
      url: rootUrl + L.Util.getParamString(parameters),
      dataType: 'jsonp',
      jsonpCallback: 'getJson',
      success: handleJson
    });
*/

    $.ajax('http://172.23.37.69:8080/geoserver/ows',{
        type: 'GET',
        data: {
            service: 'WFS',
            version: '1.1.0',
            request: 'GetFeature',
            typeName: 'mappoint:mappoint',
            //maxFeatures: 20,
            outputFormat: 'text/javascript',
            //srsname: 'EPSG:4269',
            //bbox: extent.join(',') + ',EPSG:4269',
            request: 'GetFeature'
            },
        dataType: 'jsonp',
        jsonpCallback:'callback:handleJson',
        jsonp:'format_options'
    });
    

    function handleJson(data) {
      console.log(data);
      var dataLayer = L.geoJSON(data);
      dataLayer.addTo(map);
      /*L.geoJson(data, {
          onEachFeature: onEachFeature,
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, geojsonMarkerOptions);
            //return L.marker(latlng);
          }
      }).addTo(map);*/
    }


      /* 
  $.getJSON( "http://172.23.37.69:8003/testgeojson.geojson", function( data ) {
  var items = [];
  $.each( data, function( key, val ) {
    items.push( "<li id='" + key + "'>" + val + "</li>" );
  });
 
  $( "<ul/>", {
    "class": "my-new-list",
    html: items.join( "" )
  }).appendTo( "body" );
});
*/
      </script>

          <!-- <script src = "LoadGeojsonDataFromGeoserver.js"> </script>  -->
        </body>
</html>
---------------------------------------------------------------------------------------------
Someone use a diff approach:
var owsrootUrl = 'http://185.19.29.22:8080/geoserver/cresh/ows';

var defaultParameters = {
    service : 'WFS',
    version : '1.0.0',
    request : 'GetFeature',
    typeName : 'cresh:datazone_popup',
    outputFormat : 'json',
    format_options : 'callback:getJson',
    SrsName : 'EPSG:4326'
};

var parameters = L.Util.extend(defaultParameters);
var URL = owsrootUrl + L.Util.getParamString(parameters);

var boundaries = null;
var ajax = $.ajax({
    url : URL,
    dataType : 'json',
    jsonpCallback : 'getJson',
    success : function (response) {
        boundaries = L.geoJson(response, {
            style: function (feature) {
                return {
                    stroke: false,
                    fillColor: 'FFFFFF',
                    fillOpacity: 0
                };
                }
        });
    }
});
------------ 2017-11-15 Demo-Leaflet -------------------------------
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
      
            <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
            <link rel="stylesheet" href="JixinCustomize.css" />
            
            <script src="./libs/jquery-3.2.1.min.js"></script>
    </head>
    <body>
      <div id="titel">Load WFS into Leaflet <br />
          Total Features loaded: <span id="total"></span>          
      </div>
      <div id="map"></div>
      <script>
        var map = L.map('map', {
            center: [53.554121, -113.491433],
            zoom: 10
        });
        L.esri.basemapLayer("Topographic").addTo(map);

        function BoundingBox(){
            var bounds = map.getBounds().getSouthWest().lng + "," +     map.getBounds().getSouthWest().lat + "," + map.getBounds().getNorthEast().lng + "," + map.getBounds().getNorthEast().lat;
            return bounds;
        }
        
        var geoJsonUrl ="http://172.23.37.69:8080/geoserver/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=ogp:BF_CULTURE_POINT&maxFeatures=25&outputFormat=text/javascript&format_options=callback:loadGeoJson"; 

        var geojsonLayerData = new L.GeoJSON();

        function loadGeoJson(data) {
            console.log(data);
            geojsonLayerData.addData(data);
        };

        $.ajax({ 
            url: geoJsonUrl, 
            dataType : 'jsonp',
            success: loadGeoJson
        });


        map.on('moveend', function(){
            if(map.getZoom() >= 18){
                map.removeLayer(geojsonLayerData);
            }
            
            if(map.getZoom() < 18){
                map.addLayer(geojsonLayerData);
            }

            console.log(map.getZoom());
            console.log(BoundingBox());
        });

      </script>
    </body>
</html>

-------------------------------------------------------- 2017-11-15: not working with bbox: ----------------------
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
      
            <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
            <link rel="stylesheet" href="JixinCustomize.css" />
            
            <script src="./libs/jquery-3.2.1.min.js"></script>
    </head>
    <body>
      <div id="titel">Load WFS into Leaflet <br />
          Total Features loaded: <span id="total"></span>          
      </div>
      <div id="map"></div>
      <script>
        var map = L.map('map', {
            center: [53.554121, -113.491433],
            zoom: 10
        });
        L.esri.basemapLayer("Topographic").addTo(map);

        function BoundingBox(){
            var bounds = map.getBounds().getSouthWest().lng + "," +     map.getBounds().getSouthWest().lat + "," + map.getBounds().getNorthEast().lng + "," + map.getBounds().getNorthEast().lat;
            return bounds;
        }
    
        var maxzoom = 11; 
        var geojsonLayerData = new L.GeoJSON();

        function loadGeoJson(data) {
            console.log(data);
            geojsonLayerData.addData(data);
            map.addLayer(geojsonLayerData);
        };

        map.on('moveend', function(){
            if(map.getZoom() > maxzoom){
                var geoJsonUrl ='http://172.23.37.69:8080/geoserver/ows'; 
                var defaultParameters = {
                    service: 'WFS',
                    version: '1.1.0',
                    request: 'getFeature',
                    typeName: 'ogp:BF_CULTURE_POINT',
                    maxFeatures: 3000,
                    outputFormat: 'application/json'
                };
                

                var customParams = {
                    bbox: map.getBounds().toBBoxString(),
                };

                console.log(map.getZoom());
                var parameters = L.Util.extend(defaultParameters);
                console.log("url:" + geoJsonUrl + L.Util.getParamString(parameters));

                $.ajax({
                    url: geoJsonUrl + L.Util.getParamString(parameters),
                    datatype: 'json',
                    jsonCallback: 'getJson',
                    success: loadGeoJson
                });
            } else {
                map.removeLayer(geojsonLayerData);
            };
        });

      </script>
    </body>
</html>

------------------------------------------ BBOX only works for WFS version 1.0.0 ------------------------
<html>
        <head>
          <title>GeoServer WFS Services Map Viewer</title>
          <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
          <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
          <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
    
          
    
          <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
          <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
          
                <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
                <link rel="stylesheet" href="JixinCustomize.css" />
                
                <script src="./libs/jquery-3.2.1.min.js"></script>
        </head>
        <body>
          <div id="titel">Load WFS into Leaflet <br />
              Total Features loaded: <span id="total"></span>          
          </div>
          <div id="map"></div>
          <script>
            var map = L.map('map', {
                center: [53.554121, -113.491433],
                zoom: 10
            });
            L.esri.basemapLayer("Topographic").addTo(map);
            var geojsonLayerData = new L.GeoJSON();

            // load data and add change marker
            function handleJson(data) {
                //console.log(data);
                console.log(BoundingBox());
                $("#total").html(data.features.length);
                geojsonLayerData.addData(data);
                map.addLayer(geojsonLayerData);
                
                
                /*//console.log(Object.keys(data).length);  
                console.log(data);    
                $("#total").html(data.features.length);

                L.geoJson(data, {
                    onEachFeature: onEachFeature,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    }
                }).addTo(map);
                */
            }

            // create a CircleMarker:
            var geojsonMarkerOptions = {
                radius: 8,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 0.5,
                fillOpacity: 0.8
            };
    
            load_wfs();
            // listening on map movement
            map.on('moveend', load_wfs);

            function load_wfs() {
/*                // now call wfs service to get spatial data back
                var geoJsonUrl = 'http://172.23.37.69:8080/geoserver/ows';
                var defaultParameters = {
                    service: 'WFS',
                    version: '1.1.0',
                    request: 'getFeature',
                    typeName: 'ogp:mappoint',
                    maxFeatures: 3000,
                    outputFormat: 'text/javascript',
                    format_options: 'callback: getJson',
                    srsName: 'EPSG:4326'
                };

                var customParams = {
                    bbox: map.getBounds().toBBoxString()
                };

                var parameters = L.Util.extend(defaultParameters, customParams);
                console.log(geoJsonUrl + L.Util.getParamString(parameters));
    
                var para = {
                    service: 'WFS',
                    version: '1.1.0',
                    request: 'getFeature',
                    typeName: 'ogp:mappoint',
                    outputFormat: 'text/javascript',
                    format_options: 'callback: getJson',
                    request: 'GetFeature'
                };
*/
                var xxc =$.ajax('http://172.23.37.69:8080/geoserver/ogp/ows', {
                    //jsonp: false,
                    //url: geoJsonUrl + L.Util.getParamString(parameters),
                    type: 'GET',
                    data: {
                        service: 'WFS',
                        version: '1.0.0',
                        request: 'GetFeature',
                        typeName: 'ogp:mappoint',
                        //maxFeatures: 20,
                        outputFormat: 'text/javascript',
                        //srsname: 'EPSG:3857',
                        bbox: BoundingBox, //"-113.5430145263672, 53.363665164191865, -113.44001770019531, 53.74343204185437",
                        request: 'GetFeature'
                    },
                    dataType: 'jsonp',
                    jsonpCallback:'callback:handleJson',
                    jsonp:'format_options',
                    success: 'successFunc'
                });
                console.log(xxc)
            //} else {
            //    alert("please zoom in, too many points.");
            //}
        } 

        function successFunc(){
            console.log("BoundingBox()");
        }

        function BoundingBox(){
            var bounds = map.getBounds().getSouthWest().lng + "," +     map.getBounds().getSouthWest().lat + "," + map.getBounds().getNorthEast().lng + "," + map.getBounds().getNorthEast().lat;
            return bounds;
        }

            /*
            function BoundingBox(){
                var bounds = map.getBounds().getSouthWest().lng + "," +     map.getBounds().getSouthWest().lat + "," + map.getBounds().getNorthEast().lng + "," + map.getBounds().getNorthEast().lat;
                return bounds;
            }
            
            var geoJsonUrl ="http://172.23.37.69:8080/geoserver/ows?service=WFS&version=1.1.0&request=GetFeature&typeName=ogp:mappoint&maxFeatures=3000&outputFormat=text/javascript&format_options=callback:loadGeoJson"; 
    
            var geojsonLayerData = new L.GeoJSON();
    
            function loadGeoJson(data) {
                console.log(data);
                geojsonLayerData.addData(data);
            };
    
            $.ajax({ 
                url: geoJsonUrl, 
                dataType : 'jsonp',
                success: loadGeoJson
            });
    
    
            map.on('moveend', function(){
                if(map.getZoom() >= 18){
                    map.removeLayer(geojsonLayerData);
                }
                
                if(map.getZoom() < 18){
                    map.addLayer(geojsonLayerData);
                }
    
                console.log(map.getZoom());
                console.log(BoundingBox());
            });
    */
          </script>
        </body>
    </html>
    
---------------------------------- 2017-11-16 Demo-esri-Leaflet Working but with parseRespondse ------------------------------------------
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>

      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="JixinCustomize.css" />
      
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <style>
        
            html,
            body,
            #map {
              height: 100%;
              width: 100%;
              margin: 0;
              padding: 0;
            }
        
          </style>
    </head>
    <body>

      <div id="titel">Load WFS into Leaflet <br />
          Total Features loaded: <span id="total"></span>          
      </div> 
      
      <div id="map"></div>
      <script>
        var baseLayerGroup = {
            "Topographic": L.esri.basemapLayer("Topographic"),
            "Gray": L.esri.basemapLayer("Gray"),
            "DarkGray": L.esri.basemapLayer("DarkGray"),
            "Imagery": L.esri.basemapLayer("Imagery"),
            "GrayLabels": L.esri.basemapLayer("GrayLabels"),
            "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
        };
  
        var map = L.map('map', {
          center: [53.554121, -113.491433],
          zoom: 10,
          layers: [baseLayerGroup.Topographic]
        });
        
        L.control.layers(baseLayerGroup).addTo(map);

        // load data and add change marker
        function handleJson(data) {
            //console.log(Object.keys(data).length);  
            console.log(data);    
            $("#total").html(data.features.length);

            L.geoJson(data, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            }).addTo(map);
        }

        
        var start_at_zoom = 8;

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.title) {
                layer.bindPopup(feature.properties.title);
            }
        }

        load_wfs();    
  
        // listening on map movement
        map.on('moveend', load_wfs);
  
        // create a CircleMarker:
        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        // load data and add change marker
        function parseResponse(data) {
            //console.log(Object.keys(data).length);  
            console.log(data);    
            $("#total").html(data.features.length);

            L.geoJson(data, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            }).addTo(map);
        }
  
        function load_wfs() {
            if (map.getZoom() > start_at_zoom) {
                // now call wfs service to get spatial data back
                var geoJsonUrl = 'http://172.23.37.69:8080/geoserver/ogp/ows';
                var defaultParameters = {
                    service: 'WFS',
                    version: '1.0.0',
                    request: 'getFeature',
                    typeName: 'ogp:mappoint',
                    maxFeatures: 3000,
                    outputFormat: 'text/javascript',
                    srsName: 'EPSG:4326'
                };

                var customParams = {
                    bbox: map.getBounds().toBBoxString()
                };

                var parameters = L.Util.extend(defaultParameters, customParams);
                console.log(geoJsonUrl + L.Util.getParamString(parameters));

                $.ajax({
                    url: geoJsonUrl + L.Util.getParamString(parameters),
                    dataType: 'jsonp'
                    //jsonpCallback: 'xxxyyy'
                });
            } else {
                alert("please zoom in, too many points.");
            }
        } 

        function BoundingBox(){
            var bounds = map.getBounds().getSouthWest().lng + "," +     map.getBounds().getSouthWest().lat + "," + map.getBounds().getNorthEast().lng + "," + map.getBounds().getNorthEast().lat;
            return bounds;
        }

    </script>
    </body>
</html>

-------------------- 2017-11-20 - Intersects polygon done --------------------
Demo-esri-Leaflet.html
<html>
        <head>
          <title>GeoServer WFS Services Map Viewer</title>
          <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
          <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
          <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
    
          <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
          <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
    
          <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
          <link rel="stylesheet" href="JixinCustomize.css" />
          
          <script src="./libs/jquery-3.2.1.min.js"></script>
          <style>
            
                html,
                body,
                #map {
                  height: 100%;
                  width: 100%;
                  margin: 0;
                  padding: 0;
                }
            
              </style>
        </head>
        <body>
    
          <div id="titel">Load WFS into Leaflet <br />
              Total Features loaded: <span id="total"></span>          
          </div> 
          
          <div id="map"></div>
          <script>
            var baseLayerGroup = {
                "Topographic": L.esri.basemapLayer("Topographic"),
                "Gray": L.esri.basemapLayer("Gray"),
                "DarkGray": L.esri.basemapLayer("DarkGray"),
                "Imagery": L.esri.basemapLayer("Imagery"),
                "GrayLabels": L.esri.basemapLayer("GrayLabels"),
                "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
            };
      
            var map = L.map('map', {
              center: [53.554121, -113.491433],
              zoom: 10,
              layers: [baseLayerGroup.Topographic]
            });
            
            L.control.layers(baseLayerGroup).addTo(map);
    
            // load data and add change marker
            function handleJson(data) {
                //console.log(Object.keys(data).length);  
                console.log(data);    
                $("#total").html(data.features.length);
    
                L.geoJson(data, {
                    onEachFeature: onEachFeature,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    }
                }).addTo(map);
            }
    
            
            var start_at_zoom = 8;
    
            function onEachFeature(feature, layer) {
                if (feature.properties && feature.properties.title) {
                    layer.bindPopup(feature.properties.title);
                }
            }
    
            load_wfs();    
      
            // listening on map movement
            map.on('moveend', load_wfs);
      
            // create a CircleMarker:
            var geojsonMarkerOptions = {
                radius: 8,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };
    
            // load data and add change marker
            function parseResponse(data) {
                //console.log(Object.keys(data).length);  
                console.log(data);    
                $("#total").html(data.features.length);
    
                L.geoJson(data, {
                    onEachFeature: onEachFeature,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    }
                }).addTo(map);
            }
      
            function load_wfs() {
                if (map.getZoom() > start_at_zoom) {
                    // now call wfs service to get spatial data back
                    var geoJsonUrl = 'http://172.23.37.69:8080/geoserver/ogp/wfs';
                    var defaultParameters = {
                        service: 'WFS',
                        version: '2.0.0',
                        request: 'getFeature',
                        typeName: 'ogp:mappoint',
                        maxFeatures: 3000,
                        outputFormat: 'text/javascript',
                        srsName: 'EPSG:4326'
                    };
    
                    var customParams = {
                        bbox: BoundingBox() //map.getBounds().toBBoxString()
                    };

                    var cql_filter = '&cql_filter=intersects%28point_geom%2CPOLYGON%28%2853.211133%20-113.807376%2C53.211133%20-113.388068%2C53.818406%20-113.388068%2C53.818406%20-113.807376%2C53.211133%20-113.807376%29%29%29'

    
                    var parameters = L.Util.extend(defaultParameters); //, customParams);
                    console.log(geoJsonUrl + L.Util.getParamString(parameters) + cql_filter);
    
                    $.ajax({
                        url: geoJsonUrl + L.Util.getParamString(parameters) + cql_filter,
                        dataType: 'jsonp',
                        jsonp:'format_options'
                        //jsonpCallback: 'xxxyyy'
                    });
                } else {
                    alert("please zoom in, too many points.");
                }
            } 
    
            function BoundingBox(){
                var bounds = map.getBounds().getSouthWest().lng + "," +     map.getBounds().getSouthWest().lat + "," + map.getBounds().getNorthEast().lng + "," + map.getBounds().getNorthEast().lat;
                return bounds;
            }
    
        </script>
        </body>
    </html>
--------------------- 2017-11-21 - ------------
Demo-region-picker.html
1. add region polygon wfs layer
2. add region name to dropdown
3. highlight polygon when click
4. export polygon as WKT?
5. Select from dropdown?

<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>

      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="JixinCustomize.css" />
      
      <script src="./libs/jquery-3.2.1.min.js"></script>

    </head>
    <body>

      <div id="titel">Total Features loaded: <span id="total"></span>          
      </div> 
      
      <div id="map" style="width: 500px; height: 700px;"></div>
      <script>
        var baseLayerGroup = {
            "Topographic": L.esri.basemapLayer("Topographic"),
            "Gray": L.esri.basemapLayer("Gray"),
            "DarkGray": L.esri.basemapLayer("DarkGray"),
            "Imagery": L.esri.basemapLayer("Imagery"),
            "GrayLabels": L.esri.basemapLayer("GrayLabels"),
            "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
        };
  
        var map = L.map('map', {
          center: [53.554121, -113.491433],
          zoom: 10,
          layers: [baseLayerGroup.Topographic]
        });

        L.control.layers(baseLayerGroup).addTo(map);
        load_wfs();

        // Style the layer

        // load wfs layer
        function load_wfs(){
            // now call wfs service to get spatial data back
            var geoJsonUrl = 'http://172.23.37.69:8080/geoserver/ogp/wfs';
            var defaultParameters = {
                service: 'WFS',
                version: '2.0.0',
                request: 'getFeature',
                typeName: 'ogp:BF_PROV_ELECTORAL_DIVISION',
                maxFeatures: 3000,
                outputFormat: 'text/javascript',
                srsName: 'EPSG:4326'
            };
            console.log(geoJsonUrl + L.Util.getParamString(L.Util.extend(defaultParameters)));

            $.ajax({
                url: geoJsonUrl + L.Util.getParamString(L.Util.extend(defaultParameters)),
                dataType: 'jsonp',
                jsonp:'format_options'
            });
        }
        
        var bounds = L.latLngBounds([]);
        var regionsLegend = L.control({
            position: 'bottomright',
            placeholder: 'Select Region:'
        });
        var divRegions = L.DomUtil.create('div', 'Regions');
        var regions = [];
        var selectedPolygon;

        function parseResponse(data) {
            //console.log(Object.keys(data).length);  
            console.log(data);    
            $("#total").html(data.features.length);

            //Zoom to layer            
            L.geoJson(data, {
                onEachFeature: onEachFeature
            }).addTo(map);

            // Create new geojson layer to hightlight the polygon
            new L.GeoJSON(data, {
                // Set default style
                'style': function () {
                    return {
                        'color': 'yellow',
                    }
                }
            }).on('click', function (e) {
                highLight(e);
            }).addTo(map);

            // once we've looped through all the features, zoom the map to the extent of the collection
            map.fitBounds(bounds);

            //update innerHtml of divRegions
            var str =''
            for (var i = 0; i < regions.length; i++) {
                str += '<option>' + regions[i] + '</option>';
            }
            divRegions.innerHTML = '<select>' + str + '</select>';
        }
        
        regionsLegend.onAdd = function (map) {
            divRegions.innerHTML = '<select></select>';
            divRegions.firstChild.onmousedown = divRegions.firstChild.ondblclick = L.DomEvent.stopPropagation;
            return divRegions;
        };

        function highLight(e){
            console.log(e.layer)
            // Check for selected
            if (selectedPolygon) {
                // Reset selected to default style
                e.target.resetStyle(selectedPolygon)
            }
            
            // Assign new selected
            selectedPolygon = e.layer;

            // Bring selected to front
            selectedPolygon.bringToFront();

            // Style selected
            selectedPolygon.setStyle({
                'color': 'blue', //'black' //'darkblue' //'red' //'blue' //'grey'
                /*
                color: "#000",
                fillColor: "#fff",
                weight: 2,
                opacity: 0.65
                */              
            })
        }

        regionsLegend.addTo(map);
        function onEachFeature(feature, layer) {
            // get the bounds of an individual feature
            var layerBounds = layer.getBounds();
                
            // extend the bounds of the collection to fit the bounds of the new feature
            bounds.extend(layerBounds);

            // Add all feature name to dropdown control
            if (feature.properties && feature.properties.edname) {
                regions.push(feature.properties.edname);
                //console.log(feature.properties.edname);
            };

            layer.on({
                click: function(e) {
                    //calls up the feature clicked on
                    var $layer = e.target;
                    var highlightStyle = {
                        opacity: 1,
                        weight: 5
                    };
            
                    $layer.bringToFront();
                    $layer.setStyle(highlightStyle);
                }
            }); 
        }

        // Listening on region changes, highlight the polygon, generate WKT string
        L.DomEvent.on(divRegions, 'change', this.changeRegion, this);        
        function changeRegion()
        {
            console.log("kkkkkkkkkk");
        }

        
    </script>
    </body>
</html>





<!-- 
    // Add region layer from wms service
    https://gist.github.com/alexgleith/8ff4794153c7fc0124b3

    // Leaflet example select/deselect feature and give attributes of selected features 
    https://github.com/spatialhast/leaflet.select

    // Adding drop-down menu on leaflet map instead of L.control: 
    https://gis.stackexchange.com/questions/131157/adding-drop-down-menu-on-leaflet-map-instead-of-l-control

    // 
    
//
var regionLayer= L.tileLayer.wms("http://172.23.37.69:8080/geoserver/ogp/wms", {
    layers: 'ogp:BF_PROV_ELECTORAL_DIVISION',
    format: 'image/png',
    transparent: true
});
map.addLayer(wmsLayer);


-->

---------------------------- 2017-11-22 Demo-region-picker-----------------------------------------------------------------------    
    1. wkt conversion, also convert multipolygon to simple polygon - QGIS
    2. select, highlight, and zoom to the feature
    
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>

      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="JixinCustomize.css" />
      
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <script src="./src/WKT.js"></script>
      <style>#map { width: 500px; height: 700px; }
      </style>
    </head>
    <body>

      <div id="titel">Total Features loaded: <span id="total"></span>          
      </div> 
      
      <div id="map"></div>
      <script>
        var baseLayerGroup = {
            "Topographic": L.esri.basemapLayer("Topographic"),
            "Gray": L.esri.basemapLayer("Gray"),
            "DarkGray": L.esri.basemapLayer("DarkGray"),
            "Imagery": L.esri.basemapLayer("Imagery"),
            "GrayLabels": L.esri.basemapLayer("GrayLabels"),
            "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
        };
  
        var map = L.map('map', {
          center: [53.554121, -113.491433],
          zoom: 10,
          layers: [baseLayerGroup.Topographic]
        });

        L.control.layers(baseLayerGroup).addTo(map);
        load_wfs();

        // load wfs layer
        function load_wfs(){
            // now call wfs service to get spatial data back
            var geoJsonUrl = 'http://172.23.37.69:8080/geoserver/ogp/wfs';
            var defaultParameters = {
                service: 'WFS',
                version: '2.0.0',
                request: 'getFeature',
                typeName: 'ogp:BF_PROV_ELECT_DIVISION_03',
                maxFeatures: 3000,
                outputFormat: 'text/javascript',
                srsName: 'EPSG:4326'
            };
            console.log(geoJsonUrl + L.Util.getParamString(L.Util.extend(defaultParameters)));

            $.ajax({
                url: geoJsonUrl + L.Util.getParamString(L.Util.extend(defaultParameters)),
                dataType: 'jsonp',
                jsonp:'format_options'
            });
        }
        
        var bounds = L.latLngBounds([]);
        var regionsLegend = L.control({
            position: 'bottomright',
            placeholder: 'Select Region:'
        });
        var divRegions = L.DomUtil.create('div', 'Regions');
        var regions = [];
        var selectedPolygon;
        var geojsonLayer;

        function parseResponse(data) {
            $("#total").html(data.features.length);

            //Zoom to layer            
            L.geoJson(data, {
                onEachFeature: onEachFeature
            }).addTo(map);

            // Create new geojson layer to hightlight the polygon
            geojsonLayer = new L.GeoJSON(data, {
                // Set default style
                'style': function () {
                    return {
                        'color': 'yellow',
                    }
                }
            //}).bindPopup(function (layer) {
            //    return layer.feature.properties.edname;
            }).on('click', function (e) {
                highLight(e);
            }).addTo(map);

            // once we've looped through all the features, zoom the map to the extent of the collection
            map.fitBounds(bounds);

            //update innerHtml of divRegions
            var str =''
            for (var i = 0; i < regions.length; i++) {
                str += '<option>' + regions[i] + '</option>';
            }
            divRegions.innerHTML = '<select id="selectRegion">' + str + '</select>';
        }
        
        regionsLegend.onAdd = function (map) {
            divRegions.innerHTML = '<select id="selectRegion"></select>';
            divRegions.firstChild.onmousedown = divRegions.firstChild.ondblclick = L.DomEvent.stopPropagation;
            return divRegions;
        };

        function highLight(e){
            // Check for selected
            if (selectedPolygon) {
                // Reset selected to default style
                e.target.resetStyle(selectedPolygon)
            }
            
            // Assign new selected
            selectedPolygon = e.layer;

            // Bring selected to front
            selectedPolygon.bringToFront();

            // Style selected
            selectedPolygon.setStyle({
                'color': 'blue', //'black' //'darkblue' //'red' //'blue' //'grey'
                /*
                color: "#000",
                fillColor: "#fff",
                weight: 2,
                opacity: 0.65
                */              
            })

            // get WKT format spatial coverage data
            if (selectedPolygon) {
                //console.log(toWKT(e.layer));
                toWKT(e.layer);
            }
        }

        // only convert polygon for now
        function toWKT(wfsLayer) {
            console.log(wfsLayer.feature.properties.edname);
            var strRet = '';
            var coords = [];
            if (wfsLayer instanceof L.Polygon) {
                if (wfsLayer.feature.geometry.type == 'Polygon'){
                    for (var i = 0; i < wfsLayer.feature.geometry.coordinates[0].length; i++) {
	    	            coords.push(wfsLayer.feature.geometry.coordinates[0][i][1] + " " + wfsLayer.feature.geometry.coordinates[0][i][0]);
                    };
                } else if (wfsLayer.feature.geometry.type == 'MultiPolygon'){
                    alert("Cannot handle MultiPolygon, please import this layer into PostGIS as simple polygon using QGIS.");
                    return strRet
                } else {
                    alert("Cannot handle '" + wfsLayer.feature.geometry.type + "' type, only convert simple polygon for now.");
                    return strRet
                }
            } else {
                alert("Only convert simple polygon for now.");
                return strRet
            }

            if (wfsLayer instanceof L.Polygon) {
                
                if (coords.length > 0) {
                    for (var i = 0; i < coords.length; i++) {
                        strRet += coords[i] + ",";
                    };
                    strRet = strRet.slice(0, -1);
                    strRet = "POLYGON((" + strRet + "))";
                }
                return strRet;
            }else {
                alert("Only convert simple polygon for now.");
                return strRet
            }
        }

        regionsLegend.addTo(map);
        
        function onEachFeature(feature, layer) {
            // get the bounds of an individual feature
            var layerBounds = layer.getBounds();
                
            // extend the bounds of the collection to fit the bounds of the new feature
            bounds.extend(layerBounds);

            // Add all feature name to dropdown control
            if (feature.properties && feature.properties.edname) {
                regions.push(feature.properties.edname);                
            };
        }

        // Listening on region changes, highlight the polygon, generate WKT string
        L.DomEvent.on(divRegions, 'change', this.changeRegion, this);        
        function changeRegion()
        {
            if (geojsonLayer){
                geojsonLayer.eachLayer(function(layer){
                    if (layer.feature.properties.edname == L.DomUtil.get('selectRegion').value) {
                        if (selectedPolygon) {
                            // Reset selected to default style
                            geojsonLayer.resetStyle(selectedPolygon)
                        }

                        // Assign new selected
                        selectedPolygon = layer;
                        
                        // Bring selected to front
                        selectedPolygon.bringToFront();

                        // Style selected
                        selectedPolygon.setStyle({
                            'color': 'blue', //'black' //'darkblue' //'red' //'blue' //'grey'
                        });
                        
                        // zoom to the region
                        map.fitBounds(layer.getBounds());
                    }               
                });
            }
        }
        
    </script>
    </body>
</html>





<!-- 
    // Add region layer from wms service
    https://gist.github.com/alexgleith/8ff4794153c7fc0124b3

    // Leaflet example select/deselect feature and give attributes of selected features 
    https://github.com/spatialhast/leaflet.select

    // Adding drop-down menu on leaflet map instead of L.control: 
    https://gis.stackexchange.com/questions/131157/adding-drop-down-menu-on-leaflet-map-instead-of-l-control

    // MultiPolygon and MultiLineString does not work in Leaflet 
    https://github.com/arthur-e/Wicket/issues/104
//
var regionLayer= L.tileLayer.wms("http://172.23.37.69:8080/geoserver/ogp/wms", {
    layers: 'ogp:BF_PROV_ELECTORAL_DIVISION',
    format: 'image/png',
    transparent: true
});
map.addLayer(wmsLayer);

Interactive Choropleth Map: zoomToFeature
http://leafletjs.com/examples/choropleth/
-->

---------------------- 2017-11-23 Demo-esri-Leaflet -------------------------------------------------------------
1. update base layers
2. query/bbox / intersect to any type of feature
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>

      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="JixinCustomize.css" />
      
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <style>
        
            html,
            body,
            #map {
              height: 100%;
              width: 100%;
              margin: 0;
              padding: 0;
            }
        
          </style>
    </head>
    <body>

      <div id="titel">Total Features loaded: <span id="total"></span>          
      </div> 
      
      <div id="map"></div>
      <script>
        var baseLayerGroup = {
            "Topographic": L.esri.basemapLayer("Topographic"),
            "Streets": L.esri.basemapLayer("Streets"),
            "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
            "Oceans": L.esri.basemapLayer("Oceans"),
            "Gray": L.esri.basemapLayer("Gray"),
            "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
            "DarkGray": L.esri.basemapLayer("DarkGray"),
            "Imagery": L.esri.basemapLayer("Imagery"),
            "GrayLabels": L.esri.basemapLayer("GrayLabels"),
            "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
        };
        
        var map = L.map('map', {
          center: [53.554121, -113.491433],
          zoom: 10,
          layers: [baseLayerGroup.Topographic]
        });
        
        L.control.layers(baseLayerGroup).addTo(map);

        // load data and add change marker
        function handleJson(data) {
            //console.log(Object.keys(data).length);  
            console.log(data);    
            $("#total").html(data.features.length);

            L.geoJson(data, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            }).addTo(map);
        }

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.title) {
                layer.bindPopup(feature.properties.title);
            }
        }

        load_wfs();    
  
        // listening on map movement
        map.on('moveend', load_wfs);
  
        // create a CircleMarker:
        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        // load data and add change marker
        function parseResponse(data) {
            //console.log(Object.keys(data).length);  
            //console.log(data);    
            $("#total").html(data.features.length);

            L.geoJson(data, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            }).addTo(map);
        }
  
        function load_wfs() {
                // now call wfs service to get spatial data back
                var geoJsonUrl = 'http://172.23.37.69:8080/geoserver/ogp/wfs';
                var defaultParameters = {
                    service: 'WFS',
                    version: '2.0.0',
                    request: 'getFeature',
                    typeName: 'ogp:BF_PROV_ELECTORAL_DIVISION',
                    maxFeatures: 3000,
                    outputFormat: 'text/javascript',
                    srsName: 'EPSG:4326'
                };

                var customParams = {
                    bbox: BoundingBox() //map.getBounds().toBBoxString()
                };

                var cql_filter = '&cql_filter=intersects%28geom%2CPOLYGON%28%2853.211133%20-113.807376%2C53.211133%20-113.388068%2C53.818406%20-113.388068%2C53.818406%20-113.807376%2C53.211133%20-113.807376%29%29%29'


                var parameters = L.Util.extend(defaultParameters);//, customParams);
                console.log(geoJsonUrl + L.Util.getParamString(parameters));// + cql_filter);

                $.ajax({
                    url: geoJsonUrl + L.Util.getParamString(parameters) + cql_filter,
                    dataType: 'jsonp',
                    jsonp:'format_options'
                });
        } 

        function BoundingBox(){
            var bounds =   map.getBounds().getSouthWest().lat + "," +  map.getBounds().getSouthWest().lng  + "," + map.getBounds().getNorthEast().lat + "," + map.getBounds().getNorthEast().lng;
            return bounds;
        }

    </script>
    </body>
</html>





<!--
- Show all columns in PostGIS table:
    SELECT * from information_schema.columns where table_name='BF_PROV_ELECTORAL_DIVISION';

- 

-->    

------------------------------ 2017-11-24 ------------------------------------    
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>

      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>

      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="JixinCustomize.css" />
      
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <style>
        
            html,
            body,
            #map {
              height: 100%;
              width: 100%;
              margin: 0;
              padding: 0;
            }
        
          </style>
    </head>
    <body>

      <div id="titel">Load WFS into Leaflet <br />
          Total Features loaded: <span id="total"></span>          
      </div> 
      
      <div id="map"></div>
      <script>
        var baseLayerGroup = {
            "Topographic": L.esri.basemapLayer("Topographic"),
            "Streets": L.esri.basemapLayer("Streets"),
            "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
            "Oceans": L.esri.basemapLayer("Oceans"),
            "Gray": L.esri.basemapLayer("Gray"),
            "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
            "DarkGray": L.esri.basemapLayer("DarkGray"),
            "Imagery": L.esri.basemapLayer("Imagery"),
            "GrayLabels": L.esri.basemapLayer("GrayLabels"),
            "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
        };
  
        var map = L.map('map', {
          center: [53.554121, -113.491433],
          zoom: 10,
          layers: [baseLayerGroup.Topographic]
        });
        
        L.control.layers(baseLayerGroup).addTo(map);

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.title) {
                layer.bindPopup(feature.properties.title);
            }
        }

        const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
        var isDataLayer;
        load_wfs();
        var paras;    
  
        // listening on map movement
        map.on('moveend', load_wfs);
  
        // create a CircleMarker:
        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };
        
        paras = {
            workspace: "ogp",
            version: "2.0.0",
            request: "getFeature",
            typename: 'ogp:mappoint',
            maxfeatures: '20',
            outputformat: 'text/javascript',
            srsname: 'EPSG:4326',
            //bbox: '53.171472871976334,-114.0765380859375,53.93264545156641,-112.90649414062501',
            cqlfilter: 'intersects(ogp:mappoint,POLYGON((53.211133 -113.807376,53.211133 -113.388068,53.818406 -113.388068,53.818406 -113.807376,53.211133 -113.807376)))',            
        }
        //loadWFSService(paras)

        function loadWFSService(para){
            //console.log(para)
            var requestUrl;
            // check workspace
            if (para.workspace){
                requestUrl = geoserverUrl;
                requestUrl += '/' + encodePara(para.workspace) + '/wfs?service=WFS';
            } else {
                alert("Workspace in GeoServer must be specified.")
                return
            }
            
            // check version
            if (para.version){
                requestUrl += '&version=' + encodePara(para.version);
            } else {
                alert("Version of WFS service must be specified.")
                return
            }

            // check request
            if (para.request){
                requestUrl += '&request=' + encodePara(para.request);
            } else {
                alert("Request (getFeature, getMap... )must be specified.")
                return
            }

            // check feature layer
            if (para.typename){
                requestUrl += '&typeName=' + encodePara(para.typename);
            } else {
                alert("typeName must be specified.")
                return
            }

            // check maxFeatures
            if (para.maxfeatures){
                requestUrl += '&maxFeatures=' + encodePara(para.maxfeatures);
            } 

            // check outputFormat
            if (para.outputformat){
                requestUrl += '&outputFormat=' + encodePara(para.outputformat);
            } 

            // check srsName
            if (para.srsname){
                requestUrl += '&srsName=' + encodePara(para.srsname);
            } 

            // check bbox
            if (para.bbox){
                requestUrl += '&bbox=' + encodePara(para.bbox);
            } 

            // check cql_filter
            if (para.cqlfilter){
                requestUrl += '&cql_filter=' + encodePara(para.cqlfilter);
                //console.log(encodePara(para.cqlfilter));                                                
            }             

            if (para.isdatalayer){
                isDataLayer = true;               
            } else {
                isDataLayer = false;
            }
console.log("FFFFFFFFFFFFFFFFF")
            console.log(requestUrl);
            console.log("ggggggggggggggggggggggggggggggg")
           // call jQuery call back function
            $.ajax({
                    url: requestUrl,
                    dataType: 'jsonp'
                });
        }

        function replaceAll(str, find, replace) {
            var $r="";
            while($r!=str){ 
                $r = str;
                str = str.replace(find, replace);
            }
            return str;
        }

        function encodePara(para){
            var strRet=para
            strRet = replaceAll(strRet, ')', '%29');
            strRet = replaceAll(strRet, ' ', '%20');
            strRet = replaceAll(strRet, ',', '%2C');
            strRet = replaceAll(strRet, '/', '%2F');
            strRet = replaceAll(strRet, ':', '%3A');
            strRet = replaceAll(strRet, '(', '%28');
            strRet = replaceAll(strRet, ')', '%29');
            return strRet;
        }

        function load_wfs() {
                // now call wfs service to get spatial data back
                var geoJsonUrl = geoserverUrl + '/ogp/wfs';
                var defaultParameters = {
                    service: 'WFS',
                    version: '2.0.0',
                    request: 'getFeature',
                    typeName: 'ogp:mappoint',
                    maxFeatures: 3000,
                    outputFormat: 'text/javascript',
                    srsName: 'EPSG:4326'
                    
                };
                var para = '&cql_filter=intersects%28geom%3Amappoint%2CPOLYGON%28%2853.211133%20-113.807376%2C53.211133%20-113.388068%2C53.818406%20-113.388068%2C53.818406%20-113.807376%2C53.211133%20-113.807376%29%29%29'
               //var para='&bbox=53.171472871976334%2C-114.0765380859375%2C53.93264545156641%2C-112.90649414062501'

               
               //

                var parameters = L.Util.extend(defaultParameters);
                console.log(geoJsonUrl + L.Util.getParamString(parameters) +para);

                $.ajax({
                    url: geoJsonUrl + L.Util.getParamString(parameters)+para,
                    dataType: 'jsonp'
                });
        } 

        // Call back function: will use the default 'parseResponse' instead of : formatOptions = '&format_options=callback:testme'
        function parseResponse(data) {
            //console.log(Object.keys(data).length);  
            console.log(data);    
            $("#total").html(data.features.length);

            L.geoJson(data, {
                onEachFeature: onEachFeature,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            }).addTo(map);
        }

        function BoundingBox(){
            var bounds =  map.getBounds().getSouthWest().lat + "," + map.getBounds().getSouthWest().lng + "," + map.getBounds().getNorthEast().lat + "," + map.getBounds().getNorthEast().lng;
            return bounds;
        }

    </script>
    </body>
</html>    

-------------------------------------------------------------
<html>
        <head>
          <title>GeoServer WFS Services Map Viewer</title>
          <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
          <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
          <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
    
          <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
          <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
          <script src="./libs/jquery-3.2.1.min.js"></script>
          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    
          <!-- user code -->
          <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
          <link rel="stylesheet" href="./src/JixinCustomize.css" />
          <script src="./src/DocOnMap.js"></script>
        </head>
        <body>
            <div id="divContainer">
                <div id="titel">Total Features loaded: <span id="total"></span></div>
                <div id="dropdown">                
                        <select id="dropdownRegion" onchange="LoadRegionLayer()">  <!--Call run() function-->
                            <option value="BF_PROV_ELECTORAL_DIVISION">Prov Electoral Division</option>
                            <option value="BF_WILDERNESS_AREA_POLYGON">Wilderness Area</option>
                            <option value="BF_WILDFIRE_MGMT_POLYGON">Wildfire MGMT</option>
                            <option value="BF_TREATY_POLYGON">TREATY</option>     
                       </select>
                </div>
                <div id="map"></div>
            </div>       
            
            <script>
                'use strict';
                // prepare base layers
                var baseLayerGroup = {
                    "Topographic": L.esri.basemapLayer("Topographic"),
                    "Streets": L.esri.basemapLayer("Streets"),
                    "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
                    "Oceans": L.esri.basemapLayer("Oceans"),
                    "Gray": L.esri.basemapLayer("Gray"),
                    "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
                    "DarkGray": L.esri.basemapLayer("DarkGray"),
                    "Imagery": L.esri.basemapLayer("Imagery"),
                    "GrayLabels": L.esri.basemapLayer("GrayLabels"),
                    "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
                };
      
            // load map object
            var map = L.map('map', {
              center: [53.554121, -113.491433],
              zoom: 10,
              layers: [baseLayerGroup.Topographic]
            });
            
            L.control.layers(baseLayerGroup).addTo(map);
    
            const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
            var regionLayer;
            var docLayer;
            var paras;
    
            paras = {
                    workspace: "ogp",
                    version: "2.0.0",
                    request: "getFeature",
                    typename: 'ogp:mappoint',
                    maxfeatures: '20',
                    outputformat: 'text/javascript',
                    srsname: 'EPSG:4326',
                    bbox: BoundingBox(),//'53.171472871976334,-114.0765380859375,53.93264545156641,-112.90649414062501',
                    //cqlfilter: 'intersects(point_geom,POLYGON((53.211133 -113.807376,53.211133 -113.388068,53.818406 -113.388068,53.818406 -113.807376,53.211133 -113.807376)))',            
            }
    
            LoadRegionLayer();
            load_wfs();
    
            // listening on map movement
            map.on('moveend', load_wfs);
      
            // create a CircleMarker:
            var geojsonMarkerOptions = {
                radius: 8,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };
            
    
            function replaceAll(str, find, replace) {
                var $r="";
                while($r!=str){ 
                    $r = str;
                    str = str.replace(find, replace);
                }
                return str;
            }
    
            function encodePara(para){
                var strRet=para
                strRet = replaceAll(strRet, ')', '%29');
                strRet = replaceAll(strRet, ' ', '%20');
                strRet = replaceAll(strRet, ',', '%2C');
                strRet = replaceAll(strRet, '/', '%2F');
                strRet = replaceAll(strRet, ':', '%3A');
                strRet = replaceAll(strRet, '(', '%28');
                strRet = replaceAll(strRet, ')', '%29');
                return strRet;
            }
    
            function composeUrlString() {
                var requestUrl;
                // check workspace
                if (paras.workspace){
                    requestUrl = geoserverUrl;
                    requestUrl += '/' + encodePara(paras.workspace) + '/wfs?service=WFS';
                } else {
                    alert("Workspace in GeoServer must be specified.")
                    return
                }
                
                // check version
                if (paras.version){
                    requestUrl += '&version=' + encodePara(paras.version);
                } else {
                    alert("Version of WFS service must be specified.")
                    return
                }
    
                // check request
                if (paras.request){
                    requestUrl += '&request=' + encodePara(paras.request);
                } else {
                    alert("Request (getFeature, getMap... )must be specified.")
                    return
                }
    
                // check feature layer
                if (paras.typename){
                    requestUrl += '&typeName=' + encodePara(paras.typename);
                } else {
                    alert("typeName must be specified.")
                    return
                }
    
                // check maxFeatures
                if (paras.maxfeatures){
                    requestUrl += '&maxFeatures=' + encodePara(paras.maxfeatures);
                } 
    
                // check outputFormat
                if (paras.outputformat){
                    requestUrl += '&outputFormat=' + encodePara(paras.outputformat);
                } 
    
                // check srsName
                if (paras.srsname){
                    requestUrl += '&srsName=' + encodePara(paras.srsname);
                } 
    
                // check bbox
                if (paras.bbox){
                    requestUrl += '&bbox=' + encodePara(BoundingBox());
                } 
    
                // check cql_filter
                if (paras.cqlfilter){
                    requestUrl += '&cql_filter=' + encodePara(paras.cqlfilter);
                    //console.log(encodePara(paras.cqlfilter));                                                
                }             
                return requestUrl;
            }
    
            // Compose the paras object before call
            function load_wfs() {
                    console.log(composeUrlString())
                    $.ajax({
                        url: composeUrlString(),//geoJsonUrl + L.Util.getParamString(parameters)+para,
                        dataType: 'jsonp'
                    });
            } 
    
            // Call back function: will use the default 'parseResponse' instead of : formatOptions = '&format_options=callback:testme'
            function parseResponse(data) {
                $("#total").html(data.features.length);
    
                L.geoJson(data, {
                    onEachFeature: onEachFeature,
                    pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                    }
                }).addTo(map);
            }
    
            function onEachFeature(feature, layer) {
                if (feature.properties && feature.properties.title) {
                    layer.bindPopup(feature.properties.title);
                }
            }
    
            function BoundingBox(){
                var bounds =  map.getBounds().getSouthWest().lat + "," + map.getBounds().getSouthWest().lng + "," + map.getBounds().getNorthEast().lat + "," + map.getBounds().getNorthEast().lng;
                return bounds;
            }
    
            function LoadRegionLayer() {
                console.log( document.getElementById("dropdownRegion").value);
                
                paras = {
                    workspace: "ogp",
                    version: "2.0.0",
                    request: "getFeature",
                    typename: 'ogp:' + document.getElementById("dropdownRegion").value,
                    maxfeatures: '100',
                    outputformat: 'text/javascript',
                    srsname: 'EPSG:4326',
                    returnlayer: regionLayer,
                    addtomap: true
                    //bbox: BoundingBox(),//'53.171472871976334,-114.0765380859375,53.93264545156641,-112.90649414062501',
                    //cqlfilter: 'intersects(point_geom,POLYGON((53.211133 -113.807376,53.211133 -113.388068,53.818406 -113.388068,53.818406 -113.807376,53.211133 -113.807376)))',            
            }
    
        }
    
        </script>
        </body>
    </html>

----------------- 2017-11-28 check element has class ---------------------------------------
http://jsfiddle.net/fkling/zBKCC/
function hasClass(element, cls) {
    return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
}

var el = document.getElementById('test');

alert(hasClass(el, 'class1'));
alert(hasClass(el, 'class'));

---------------------2017-11-28 Main app---------------------
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
      
      <link rel="stylesheet" type="text/css" href="./libs/leaflet-freedraw.css" />
      <script src="./libs/leaflet-1.2.0/leaflet-src.js"></script>
      <script src="./libs/leaflet-freedraw.web.js"></script>
      
      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

      <!-- user code -->
      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="./src/JixinCustomize.css" />
      <script src="./src/DocOnMap.js"></script>
    </head>
    <body>
        <div id="divContainer">
            <div class='container'>
                <div class='row'>
                    <div class='btn'>Total Features loaded: <span id="total"></span></div> 
                    <div class='btn'>Map Layer Count: <span id="layercount"></span></div> 
                    <div class='btn'><button onclick="ClickMe()">Click me</button></div>
                    <div class='btn'><button onclick="FreeDraw()">Free Draw Polygon</button></div>
                    <div class='btn'><button onclick="ClearDraw()">Clear Polygon</button></div>
                </div>
            </div>
            <div class='container'>                
                <div class='row'>
                    <div id="dicSearchMode" class='btn'>                
                        <select id="dropdownSearchMode" onchange="LoadSearchMode()"> 
                            <option value="0">Search Current Extent</option>
                            <option value="1">Search by Region</option>
                            <option value="2">Search by Drawing an Area</option>
                    </select>
                    </div>
                    <div id="divRegion" class='btn'>                
                        <select id="dropdownRegion" onchange="LoadRegionLayer()">  <!--Call run() function-->
                            <option value="ogp:BF_PROV_ELECTORAL_DIVISION">Prov Electoral Division</option>
                            <option value="ogp:BF_WILDERNESS_AREA_POLYGON">Wilderness Area</option>
                            <option value="ogp:BF_WILDFIRE_MGMT_POLYGON">Wildfire MGMT</option>
                            <option value="ogp:BF_TREATY_POLYGON">TREATY</option>     
                        </select>
                    </div>
                    <div id="divRegionDetail" class='btn'>                
                        <select id="dropdownRegionDetail" onchange="LoadRegionDetail()">  <!--Call run() function-->
                        </select>
                    </div>        
                <div>
            </div>
        </div>       
        <section class="map" id="map"></section>
         
        <script>
            'use strict';
            const geoserverUrl = 'http://172.23.37.69:8080/geoserver';

            // prepare base layers
            var baseLayerGroup = {
                "Topographic": L.esri.basemapLayer("Topographic"),
                "Streets": L.esri.basemapLayer("Streets"),
                "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
                "Oceans": L.esri.basemapLayer("Oceans"),
                "Gray": L.esri.basemapLayer("Gray"),
                "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
                "DarkGray": L.esri.basemapLayer("DarkGray"),
                "Imagery": L.esri.basemapLayer("Imagery"),
                "GrayLabels": L.esri.basemapLayer("GrayLabels"),
                "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
            };
  
        // load map object
        var map = L.map('map', {
          center: [53.554121, -113.491433],
          zoom: 10
        });

        var baselayer = baseLayerGroup.Topographic;
        map.addLayer(baselayer);

        L.control.layers(baseLayerGroup).addTo(map);
    
        var paras;
        var docLayer;
        var regionLayer;
        var customLayer;
        var selectRegion;
        var regions = [];
        var bounds = L.latLngBounds([]);
        
        paras = {
                workspace: "ogp",
                version: "2.0.0",
                request: "getFeature",
                typename: 'ogp:BF_CULTURE_POINT',
                layertype: '0',  //Doc layer
                maxfeatures: '300',
                outputformat: 'text/javascript',
                srsname: 'EPSG:4326',
                bbox: BoundingBox(),//'53.171472871976334,-114.0765380859375,53.93264545156641,-112.90649414062501',
                //cqlfilter: 'intersects(point_geom,POLYGON((53.211133 -113.807376,53.211133 -113.388068,53.818406 -113.388068,53.818406 -113.807376,53.211133 -113.807376)))',            
        }
        load_wfs();

        $('#dropdownSearchMode').val(0);
        changeMode();

        // create a CircleMarker:
        var geojsonMarkerOptions = {
            radius: 8,
            fillColor: "#ff7800",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };        

        function replaceAll(str, find, replace) {
            var $r="";
            while($r!=str){ 
                $r = str;
                str = str.replace(find, replace);
            }
            return str;
        }

        function encodePara(para){
            var strRet=para
            strRet = replaceAll(strRet, ')', '%29');
            strRet = replaceAll(strRet, ' ', '%20');
            strRet = replaceAll(strRet, ',', '%2C');
            strRet = replaceAll(strRet, '/', '%2F');
            strRet = replaceAll(strRet, ':', '%3A');
            strRet = replaceAll(strRet, '(', '%28');
            strRet = replaceAll(strRet, ')', '%29');
            return strRet;
        }

        function composeUrlString() {
            var requestUrl;
            // check workspace
            if (paras.workspace){
                requestUrl = geoserverUrl;
                requestUrl += '/' + encodePara(paras.workspace) + '/wfs?service=WFS';
            } else {
                alert("Workspace in GeoServer must be specified.")
                return
            }
            
            // check version
            if (paras.version){
                requestUrl += '&version=' + encodePara(paras.version);
            } else {
                alert("Version of WFS service must be specified.")
                return
            }

            // check request
            if (paras.request){
                requestUrl += '&request=' + encodePara(paras.request);
            } else {
                alert("Request (getFeature, getMap... )must be specified.")
                return
            }

            // check feature layer
            if (paras.typename){
                requestUrl += '&typeName=' + encodePara(paras.typename);
            } else {
                alert("typeName must be specified.")
                return
            }

            // check maxFeatures
            if (paras.maxfeatures){
                requestUrl += '&maxFeatures=' + encodePara(paras.maxfeatures);
            } 

            // check outputFormat
            if (paras.outputformat){
                requestUrl += '&outputFormat=' + encodePara(paras.outputformat);
            } 

            // check srsName
            if (paras.srsname){
                requestUrl += '&srsName=' + encodePara(paras.srsname);
            } 

            // check bbox
            if (paras.bbox){
                requestUrl += '&bbox=' + encodePara(BoundingBox());
            } 

            // check cql_filter
            if (paras.cqlfilter){
                requestUrl += '&cql_filter=' + encodePara(paras.cqlfilter);
                //console.log(encodePara(paras.cqlfilter));                                                
            }             
            return requestUrl;
        }

        // Compose the paras object before call
        function load_wfs() {
                console.log(composeUrlString())
                $.ajax({
                    url: composeUrlString(),
                    dataType: 'jsonp'
                });
        } 

        // Call back function: will use the default 'parseResponse' instead of : formatOptions = '&format_options=callback:testme'
        function parseResponse(data) {
            $("#total").html(data.features.length);
            $("#layercount").html(layerCount());
            console.log(paras.layertype);
            console.log(paras.addToMap);
            if (paras.layertype == '0'){
                if (docLayer && map.hasLayer(docLayer)){
                    map.removeLayer(docLayer);
                }
                docLayer = L.geoJson(data, {
                    onEachFeature: onEachDocFeature,
                    //pointToLayer: function (feature, latlng) {
                    //    return L.circleMarker(latlng, geojsonMarkerOptions);
                    //}
                });
                if (paras.addToMap){
                    docLayer.addTo(map);
                }
                if (paras.bringToFront){
                    docLayer.bringToFront();
                }
            } else if (paras.layertype == '1') {
                L.geoJson(data, {
                    onEachFeature: onEachRegionFeature
                });
                
                // Create new geojson layer to hightlight the polygon
                regionLayer = new L.GeoJSON(data, {
                    // Set default style
                    'style': function () {
                        return {
                            'color': 'yellow',
                        }
                    }
                //}).bindPopup(function (layer) {
                //    return layer.feature.properties.edname;
                }).on('click', function (e) {
                    highLightRegion(e);
                }).addTo(map);

                // once we've looped through all the features, zoom the map to the extent of the collection
                map.fitBounds(bounds);
                
                //update innerHtml of divRegions
                var divRegions = document.getElementById("dropdownRegionDetail");
                var str =''
                for (var i = 0; i < regions.length; i++) {
                    str += '<option>' + regions[i] + '</option>';
                }
                divRegions.innerHTML = '<select id="selectRegion">' + str + '</select>';
            } else if (paras.layertype == '2') {
                regionLayer = L.geoJson(data, {
                    onEachFeature: onEachCustomFeature
                });
                if (paras.addToMap){
                    regionLayer.addTo(map);
                }
                if (paras.bringToFront){
                    regionLayer.bringToFront();
                }
            }
        }

        function highLightRegion(e){
            // Check for selected
            if (selectRegion) {
                // Reset selected to default style
                e.target.resetStyle(selectRegion)
            }
            
            // Assign new selected
            selectRegion = e.layer;

            // Bring selected to front
            selectRegion.bringToFront();

            // Style selected
            selectRegion.setStyle({
                'color': 'blue', //'black' //'darkblue' //'red' //'blue' //'grey'
                /*
                color: "#000",
                fillColor: "#fff",
                weight: 2,
                opacity: 0.65
                */              
            })
        }

        function onEachDocFeature(feature, layer) {
            if (feature.properties && feature.properties.title) {
                layer.bindPopup(feature.properties.title);
            }
        }

        function onEachRegionFeature(feature, layer) {
            if (feature.properties && feature.properties.edname) {
                layer.bindPopup(feature.properties.edname);
            }
        
            // get the bounds of an individual feature
            var layerBounds = layer.getBounds();
                
            // extend the bounds of the collection to fit the bounds of the new feature
            bounds.extend(layerBounds);

            
            // Add all feature name to dropdown control
            if (feature.properties && feature.properties.edname) {
                regions.push(feature.properties.edname);                
            };
        }

        function BoundingBox(){
            var bounds =  map.getBounds().getSouthWest().lat + "," + map.getBounds().getSouthWest().lng + "," + map.getBounds().getNorthEast().lat + "," + map.getBounds().getNorthEast().lng;
            return bounds;
        }

        function LoadRegionLayer() {
            console.log("LoadRegionLayer");
            paras = {
                    workspace: "ogp",
                    version: "2.0.0",
                    request: "getFeature",
                    typename: document.getElementById("dropdownRegion").value,
                    layertype: '1', // region layer
                    maxfeatures: '300',
                    outputformat: 'text/javascript',
                    srsname: 'EPSG:4326',
                    addToMap: true,
                    bringToFront: false,
            }
            load_wfs();
        }

        function LoadRegionDetail() {
            console.log("LoadRegionDetail");
            paras = {
                workspace: "ogp",
                version: "2.0.0",
                request: "getFeature",
                typename: "ogp:" + document.getElementById("dropdownRegionDetail").value,
                layertype: '1', // region layer
                maxfeatures: '300',
                outputformat: 'text/javascript',
                srsname: 'EPSG:4326',
                addToMap: true,
                bringToFront: false,
            }
            load_wfs();
        }

        function LoadSearchMode() {
            console.log( document.getElementById("dropdownSearchMode").value);
            changeMode()
        }

        function changeMode() {            
            console.log("Layer Count: "+ layerCount())
            if (map.hasLayer(docLayer)){
                    map.removeLayer(docLayer); 
            }               
            docLayer = undefined;
            if (map.hasLayer(regionLayer)){
                map.removeLayer(regionLayer); 
            }               
            regionLayer = undefined;
            if (map.hasLayer(customLayer)){
                map.removeLayer(customLayer); 
            }               
            customLayer = undefined;
            
            if (document.getElementById("dropdownSearchMode").value == 0) {
                document.getElementById("dropdownRegion").disabled=true;

                paras = {
                    workspace: "ogp",
                    version: "2.0.0",
                    request: "getFeature",
                    typename: 'ogp:BF_CULTURE_POINT',
                    layertype: '0', //Document layer
                    maxfeatures: '300',
                    outputformat: 'text/javascript',
                    srsname: 'EPSG:4326',
                    bbox: BoundingBox(),
                    addToMap: true,
                    bringToFront: true,
                }
                load_wfs();
                // listening to map
                map.on('moveend', load_wfs);
                
            } else if (document.getElementById("dropdownSearchMode").value == 1) {
                // Search by region
                document.getElementById("dropdownRegion").disabled=false;
                // stop listening on moveend event
                map.off("moveend", load_wfs);

                paras = {
                    workspace: "ogp",
                    version: "2.0.0",
                    request: "getFeature",
                    typename: document.getElementById("dropdownRegion").value,
                    layertype: '1', // region layer
                    maxfeatures: '300',
                    outputformat: 'text/javascript',
                    srsname: 'EPSG:4326',
                    addToMap: true,
                    bringToFront: false,
                }
                load_wfs();
            } else if (document.getElementById("dropdownSearchMode").value == 2) {
                // search by drawing
                document.getElementById("dropdownRegion").disabled=true;
                // stop listening on moveend event
                map.off("moveend", load_wfs);
            }
        }

        function layerCount(){
            var iCount=0;
            map.eachLayer(function (layer){
                iCount++;
            });
            return iCount;
        }
        function ClickMe(){
        }
  
        function FreeDraw(){
            // remove all layer except the base layer
            ClearOverlayLayers();

            //const freeDraw = new FreeDraw({ mode: FreeDraw.ALL });
            //map.addLayer(freeDraw);
        }

        function ClearOverlayLayers(){
            map.eachLayer(function (layer) {
                if (!layerHasTilePaneClass(layer)){
                    map.removeLayer(layer);
                }
            });
        }

        function GetTileLayer(){ 
            map.eachLayer(function (layer) {
                if (layerHasTilePaneClass(layer)){
                    return layer;
                }
            });
        }

        function layerHasTilePaneClass(layer) {
            return (' ' + layer.getPane().className + ' ').indexOf(' leaflet-tile-pane ') > -1;
        }

        function ClearDraw(){
            map.eachLayer(function (layer) {
                map.removeLayer(layer);
            });
        }




  </script>
    </body>
</html>

<!--  
    Add multiple WFS layers to Leaflet map from GeoServer using JQuery Ajax calls
    https://gis.stackexchange.com/questions/242358/add-multiple-wfs-layers-to-leaflet-map-from-geoserver-using-jquery-ajax-calls

    Add WFS layer (JSON) in Leaflet using Leaflet layer tree control
    https://gis.stackexchange.com/questions/189061/add-wfs-layer-json-in-leaflet-using-leaflet-layer-tree-control/189190
-->

--------------------- 2017-11-28 -----------------------------------
// Added freedraw - working
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
      
      <link rel="stylesheet" type="text/css" href="./libs/leaflet-freedraw.css" />
      <script src="./libs/leaflet-1.2.0/leaflet-src.js"></script>
      <script src="./libs/leaflet-freedraw.web.js"></script>
      
      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

      <!-- user code -->
      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="./src/JixinCustomize.css" />
      <script src="./src/DocOnMap.js"></script>
    </head>
    <body>
        <div id="divContainer">
            <div class='container'>
                <div class='row'>
                    <div class='btn'>Total Features loaded: <span id="total"></span></div> 
                    <div class='btn'>Map Layer Count: <span id="layercount"></span></div> 
                    <div class='btn'><button onclick="ClickMe()">Click me</button></div>
                    <div class='btn'><button onclick="FreeDrawLayer()">Free Draw Polygon</button></div>
                    <div class='btn'><button onclick="DrawPolygon()">Draw Polygon</button></div>
                </div>
            </div>
            <div class='container'>                
                <div class='row'>
                    <div id="dicSearchMode" class='btn'>                
                        <select id="dropdownSearchMode" onchange="LoadSearchMode()"> 
                            <option value="0">Search Current Extent</option>
                            <option value="1">Search by Region</option>
                            <option value="2">Search by Drawing an Area</option>
                    </select>
                    </div>
                    <div id="divRegion" class='btn'>                
                        <select id="dropdownRegion" onchange="LoadRegionLayer()">  <!--Call run() function-->
                            <option value="ogp:BF_PROV_ELECTORAL_DIVISION">Prov Electoral Division</option>
                            <option value="ogp:BF_WILDERNESS_AREA_POLYGON">Wilderness Area</option>
                            <option value="ogp:BF_WILDFIRE_MGMT_POLYGON">Wildfire MGMT</option>
                            <option value="ogp:BF_TREATY_POLYGON">TREATY</option>     
                        </select>
                    </div>
                    <div id="divRegionDetail" class='btn'>                
                        <select id="dropdownRegionDetail" onchange="LoadRegionDetail()">  <!--Call run() function-->
                        </select>
                    </div>        
                <div>
            </div>
        </div>       
        <div id="map"></div>
         
        <script>
            const LAT_LNG = [53.554121, -113.491433];
            const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
            
            // prepare base layers
            var baseLayerGroup = {
                    "Topographic": L.esri.basemapLayer("Topographic"),
                    "Streets": L.esri.basemapLayer("Streets"),
                    "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
                    "Oceans": L.esri.basemapLayer("Oceans"),
                    "Gray": L.esri.basemapLayer("Gray"),
                    "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
                    "DarkGray": L.esri.basemapLayer("DarkGray"),
                    "Imagery": L.esri.basemapLayer("Imagery"),
                    "GrayLabels": L.esri.basemapLayer("GrayLabels"),
                    "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
            };
            const baselayer = baseLayerGroup.Topographic;                
            map = new L.Map(document.querySelector('#map'), { doubleClickZoom: false }).setView(LAT_LNG, 10);
            map.addLayer(baselayer);
            freeDraw = new FreeDraw({ mode: FreeDraw.ALL });
            map.addLayer(freeDraw);

            function FreeDrawLayer(){
                var i=0;
                map.eachLayer(function (layer) {
                    i++;
                    console.log(i)
                    console.log(layer);
                    //if (!layerHasTilePaneClass(layer)){
                        map.removeLayer(layer);
                    //}
                });

                map.addLayer(baselayer);
                map.addLayer(freeDraw);
i=0;
                map.eachLayer(function (layer) {
                    i++;
                    console.log(i)
                    console.log(layer);
                });

            }
            
            function ClearOverlayLayers(){
                map.eachLayer(function (layer) {
                    if (!layerHasTilePaneClass(layer)){
                        map.removeLayer(layer);
                    }
                });
            }
            
            function layerHasTilePaneClass(layer) {
                return (' ' + layer.getPane().className + ' ').indexOf(' leaflet-tile-pane ') > -1;
            }
            function ClickMe(){
                var i=0;
                map.eachLayer(function (layer) {
                    i++;
                    console.log(i)
                    console.log(layer);
                });
            }

            function DrawPolygon(){
                map.eachLayer(function (layer) {
                    map.removeLayer(layer);
                });
                
                map.addLayer(baselayer);
            freeDraw = new FreeDraw({ mode: FreeDraw.ALL });
            map.addLayer(freeDraw);
            }

        </script>
    </body>
</html>

<!--  
    Add multiple WFS layers to Leaflet map from GeoServer using JQuery Ajax calls
    https://gis.stackexchange.com/questions/242358/add-multiple-wfs-layers-to-leaflet-map-from-geoserver-using-jquery-ajax-calls

    Add WFS layer (JSON) in Leaflet using Leaflet layer tree control
    https://gis.stackexchange.com/questions/189061/add-wfs-layer-json-in-leaflet-using-leaflet-layer-tree-control/189190
-->

---------------------------------- 2017-11-28 ------------
Main():
getPolygonLatLngs output polygon string in lat lng format:
<html>
    <head>
      <title>GeoServer WFS Services Map Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
      <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
      
      <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
      <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
      <script src="./libs/jquery-3.2.1.min.js"></script>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

      <!-- user code -->
      <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
      <link rel="stylesheet" href="./src/JixinCustomize.css" />
      <script src="./src/DocOnMap.js"></script>
    </head>
    <body>
        <div id="divContainer">
            <div class='container'>
                <div class='row'>
                    <div class='btn'>Total Features loaded: <span id="total"></span></div> 
                    <div class='btn'>Map Layer Count: <span id="layercount"></span></div> 
                    <div class='btn'><button onclick="ClickMe()">Click me</button></div>
                    <div class='btn'><button onclick="ClearPolygonLayer()">Clear Polygon</button></div>
                    <div class='btn'><button onclick="DrawPolygon()">Draw Polygon</button></div>
                </div>
            </div>
            <div class='container'>                
                <div class='row'>
                    <div id="dicSearchMode" class='btn'>                
                        <select id="dropdownSearchMode" onchange="LoadSearchMode()"> 
                            <option value="0">Search Current Extent</option>
                            <option value="1">Search by Region</option>
                            <option value="2">Search by Drawing an Area</option>
                    </select>
                    </div>
                    <div id="divRegion" class='btn'>                
                        <select id="dropdownRegion" onchange="LoadRegionLayer()">  <!--Call run() function-->
                            <option value="ogp:BF_PROV_ELECTORAL_DIVISION">Prov Electoral Division</option>
                            <option value="ogp:BF_WILDERNESS_AREA_POLYGON">Wilderness Area</option>
                            <option value="ogp:BF_WILDFIRE_MGMT_POLYGON">Wildfire MGMT</option>
                            <option value="ogp:BF_TREATY_POLYGON">TREATY</option>     
                        </select>
                    </div>
                    <div id="divRegionDetail" class='btn'>                
                        <select id="dropdownRegionDetail" onchange="LoadRegionDetail()">  <!--Call run() function-->
                        </select>
                    </div>        
                <div>
            </div>
        </div>       
        <div id="map"></div>
         
        <script>
            const LAT_LNG = [53.554121, -113.491433];
            const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
            
            // prepare base layers
            var baseLayerGroup = {
                    "Topographic": L.esri.basemapLayer("Topographic"),
                    "Streets": L.esri.basemapLayer("Streets"),
                    "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
                    "Oceans": L.esri.basemapLayer("Oceans"),
                    "Gray": L.esri.basemapLayer("Gray"),
                    "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
                    "DarkGray": L.esri.basemapLayer("DarkGray"),
                    "Imagery": L.esri.basemapLayer("Imagery"),
                    "GrayLabels": L.esri.basemapLayer("GrayLabels"),
                    "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
            };
            const baselayer = baseLayerGroup.Topographic;                
            map = new L.Map(document.querySelector('#map')).setView(LAT_LNG, 10);
            map.addLayer(baselayer);
            window.polygon = null;

            function ClearPolygonLayer(){                
                if (window.polygon != null){
                    map.removeLayer(window.polygon);
                }
                    //
                
            }
            
            function ClearOverlayLayers(){
                map.eachLayer(function (layer) {
                    if (!layerHasTilePaneClass(layer)){
                        map.removeLayer(layer);
                    }
                });
            }
            
            function layerHasTilePaneClass(layer) {
                return (' ' + layer.getPane().className + ' ').indexOf(' leaflet-tile-pane ') > -1;
            }

            function ClickMe(){
                var i=0;
                map.eachLayer(function (layer) {
                    i++;
                    console.log(i)
                    console.log(layer);
                    console.log(layer.getPane());
                });
            }

            function DrawPolygon(){
                // create a red polygon from an array of LatLng points
                var latlngs = [[53.512848, -113.522564],[53.494776, -113.458535],[53.470779, -113.529689]];
                window.polygon = L.polygon(latlngs, {color: 'red'});
                window.polygon.addTo(map);
                console.log("Done");
                console.log(getPolygonLatLngs(window.polygon));
            }

        // only convert polygon for now
        function getPolygonLatLngs(layer) {
            var strRet = '';
            var coords = [];
            if (layer instanceof L.Polygon) {
                var jsonObj = layer.toGeoJSON();
                console.log(jsonObj);
                if (jsonObj.geometry.type == 'Polygon'){
                    for (var i = 0; i < jsonObj.geometry.coordinates[0].length; i++) {
	    	            coords.push(jsonObj.geometry.coordinates[0][i][1] + " " + jsonObj.geometry.coordinates[0][i][0]);
                    };
                } else if (jsonObj.geometry.type == 'MultiPolygon'){
                    alert("Cannot handle MultiPolygon, please import this layer into PostGIS as simple polygon using QGIS.");
                    return strRet
                } else {
                    alert("Cannot handle '" + jsonObj.geometry.type + "' type, only convert simple polygon for now.");
                    return strRet
                }
            } else {
                alert("Only convert simple polygon for now.");
                return strRet
            }

            if (layer instanceof L.Polygon) {
                
                if (coords.length > 0) {
                    for (var i = 0; i < coords.length; i++) {
                        strRet += coords[i] + ",";
                    };
                    strRet = strRet.slice(0, -1);
                    strRet = "POLYGON((" + strRet + "))";
                }
                return strRet;
            }else {
                alert("Only convert simple polygon for now.");
                return strRet
            }
        }

        </script>
    </body>
</html>

<!--  
    Add multiple WFS layers to Leaflet map from GeoServer using JQuery Ajax calls
    https://gis.stackexchange.com/questions/242358/add-multiple-wfs-layers-to-leaflet-map-from-geoserver-using-jquery-ajax-calls

    Add WFS layer (JSON) in Leaflet using Leaflet layer tree control
    https://gis.stackexchange.com/questions/189061/add-wfs-layer-json-in-leaflet-using-leaflet-layer-tree-control/189190
-->

------------------- 2017-12-01 ---------------------------
Demo-esri-Leaflet: freedraw working on enable / disable
<head>
        <title>GeoServer WFS Services Map Viewer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
        <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
        
        <link rel="stylesheet" type="text/css" href="./libs/leaflet-freedraw.css" />
        <script src="./libs/leaflet-1.2.0/leaflet-src.js"></script>
        <script src="./libs/leaflet-freedraw.web.js"></script>
        
        <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
        <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
        <script src="./libs/jquery-3.2.1.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    
        <!-- user code -->
        <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
        <link rel="stylesheet" href="./src/JixinCustomize.css" />
        <script src="./src/DocOnMap.js"></script>
      </head>
      <body>
          <div id="divContainer">
              <div class='container'>
                  <div class='row'>
                      <div class='btn'>Total Features loaded: <span id="total"></span></div> 
                      <div class='btn'>Map Layer Count: <span id="layercount"></span></div> 
                      <div class='btn'><button onclick="EnableFreeDraw()">Enable FreeDraw</button></div>
                      <div class='btn'><button onclick="DisableFreeDraw()">Disable FreeDraw</button></div>
                      <div class='btn'><button onclick="ClearPolygon()">Clear Polygon</button></div>
                      <div class='btn'><button onclick="QueryByPolygon()">Query By Polygon</button></div>
                  </div>
              </div>
              <div class='container'>                
                  <div class='row'>
                      <div id="dicSearchMode" class='btn'>                
                          <select id="dropdownSearchMode" onchange="LoadSearchMode()"> 
                              <option value="0">Search Current Extent</option>
                              <option value="1">Search by Region</option>
                              <option value="2">Search by Drawing an Area</option>
                      </select>
                      </div>
                      <div id="divRegion" class='btn'>                
                          <select id="dropdownRegion" onchange="LoadRegionLayer()">  <!--Call run() function-->
                              <option value="ogp:BF_PROV_ELECTORAL_DIVISION">Prov Electoral Division</option>
                              <option value="ogp:BF_WILDERNESS_AREA_POLYGON">Wilderness Area</option>
                              <option value="ogp:BF_WILDFIRE_MGMT_POLYGON">Wildfire MGMT</option>
                              <option value="ogp:BF_TREATY_POLYGON">TREATY</option>     
                          </select>
                      </div>
                      <div id="divRegionDetail" class='btn'>                
                          <select id="dropdownRegionDetail" onchange="LoadRegionDetail()">  <!--Call run() function-->
                          </select>
                      </div>        
                  <div>
              </div>
          </div>       
          <div id="map"></div>
           
          <script>
              const LAT_LNG = [53.554121, -113.491433];
              const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
              
              // prepare base layers
              var baseLayerGroup = {
                      "Topographic": L.esri.basemapLayer("Topographic"),
                      "Streets": L.esri.basemapLayer("Streets"),
                      "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
                      "Oceans": L.esri.basemapLayer("Oceans"),
                      "Gray": L.esri.basemapLayer("Gray"),
                      "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
                      "DarkGray": L.esri.basemapLayer("DarkGray"),
                      "Imagery": L.esri.basemapLayer("Imagery"),
                      "GrayLabels": L.esri.basemapLayer("GrayLabels"),
                      "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
              };
              const baselayer = baseLayerGroup.Topographic;                
              map = new L.Map(document.querySelector('#map'), { doubleClickZoom: false }).setView(LAT_LNG, 10);
              map.addLayer(baselayer);
              freeDraw = new FreeDraw({ mode: FreeDraw.ALL });
              var polygons = [];
              freeDraw.on('markers', function getMarkers(eventData) {
                  polygons = eventData.latLngs;
                  console.log(polygons);
            });
            
            /*function ResetFreeDrawLayer(){
                map.eachLayer(function (layer) {
                  if (isTypeofLayer(layer, 'leaflet-marker-pane')){
                      map.removeLayer(layer);
                  } else if(isPolygon(layer)){
                      map.removeLayer(layer);
                  }
                });
            }*/
            function DisplayLayersOnMap(){
                var i=0;
                console.log(map)
                map.eachLayer(function (layer) {
                    i++;                
                  console.log(i+": " );
                  console.log(layer);
                });
            }
              
            function isTileLayer(layer){
                try {
                    console.log(layer.getPane().className);
                    return (' ' + layer.getPane().className + ' ').indexOf(' leaflet-tile-pane ') > -1;
                }
                catch(err) {
                    console.log("return false: " + err.message);
                    //console.log(layer);
                    return false;
                }
            }
    
            function isPolygon(layer){
                try {
                    if (layer instanceof L.Polygon) {
                        return true;
                    } else {
                        return false;    
                    }
                }
                catch(err) {
                    console.log("isPolygon return false: " + err.message);
                    return false;
                }
            }
    
            function isTypeofLayer(layer, className){
                try {
                    console.log(layer.getPane().className);
                    return (' ' + layer.getPane().className + ' ').indexOf(' ' + className + ' ') > -1;
                }
                catch(err) {
                    return false;
                }
            }
    
            function ClearPolygon(){
                  freeDraw.clear();
                  DisplayLayersOnMap();
              }
            
    
            function EnableFreeDraw() {
                map.addLayer(freeDraw);
                DisplayLayersOnMap();
            }
    
            function DisableFreeDraw() {
                map.removeLayer(freeDraw);
                DisplayLayersOnMap();
            }
    
            function ClickMe(){
                var i=0;
                map.eachLayer(function (layer) {
                    i++;
                    console.log(i);
                    console.log(layer);
                  });
    
              }
    
              function QueryByPolygon(){
                map.eachLayer(function (layer) {
                    if(isPolygon(layer)){
                        console.log(getPolygonLatLngs(layer));
                    }
                  });
              }
    
            // only convert polygon for now
            function getPolygonLatLngs(layer) {
                var strRet = '';
                var coords = [];
                if (layer instanceof L.Polygon) {
                    var jsonObj = layer.toGeoJSON();
                    console.log(jsonObj);
                    if (jsonObj.geometry.type == 'Polygon'){
                        for (var i = 0; i < jsonObj.geometry.coordinates[0].length; i++) {
                            coords.push(jsonObj.geometry.coordinates[0][i][1] + " " + jsonObj.geometry.coordinates[0][i][0]);
                        };
                    } else if (jsonObj.geometry.type == 'MultiPolygon'){
                        alert("Cannot handle MultiPolygon, please import this layer into PostGIS as simple polygon using QGIS.");
                        return strRet
                    } else {
                        alert("Cannot handle '" + jsonObj.geometry.type + "' type, only convert simple polygon for now.");
                        return strRet
                    }
                } else {
                    alert("Only convert simple polygon for now.");
                    return strRet
                }
    
                if (layer instanceof L.Polygon) {
                    
                    if (coords.length > 0) {
                        for (var i = 0; i < coords.length; i++) {
                            strRet += coords[i] + ",";
                        };
                        strRet = strRet.slice(0, -1);
                        strRet = "POLYGON((" + strRet + "))";
                    }
                    return strRet;
                }else {
                    alert("Only convert simple polygon for now.");
                    return strRet
                }
            }
    
          </script>
      </body>
    </html>
    
    <!--  
        Add multiple WFS layers to Leaflet map from GeoServer using JQuery Ajax calls
        https://gis.stackexchange.com/questions/242358/add-multiple-wfs-layers-to-leaflet-map-from-geoserver-using-jquery-ajax-calls
    
        Add WFS layer (JSON) in Leaflet using Leaflet layer tree control
        https://gis.stackexchange.com/questions/189061/add-wfs-layer-json-in-leaflet-using-leaflet-layer-tree-control/189190
    
        about custom toolbar
        https://github.com/Leaflet/Leaflet.draw/issues/160
        https://github.com/Leaflet/Leaflet.draw/issues/48
        https://github.com/Leaflet/Leaflet.draw/issues/265
        https://wiki.documentfoundation.org/images/8/85/0401DG3-IntroducingDraw.pdf
        https://github.com/Leaflet/Leaflet.toolbar/blob/master/examples/subtoolbar.html
        https://github.com/leaflet/Leaflet.Toolbar/wiki/Building-custom-toolbars
        https://github.com/leaflet/Leaflet.Toolbar/wiki/API-Reference
        https://github.com/justinmanley/leaflet-draw-toolbar/blob/master/examples/combined.html
        https://github.com/Leaflet/Leaflet.toolbar/blob/master/examples/minimal.html
        https://getbounds.com/blog/a-modern-leaflet-toolbar/
        https://github.com/stefanocudini/leaflet-search
    
    -->
    ------------------------------------------ 2017-12-01 ---------------------------
    regionpicker.html done!
    <html>
            <head>
            <title>GeoServer WFS Services Map Viewer</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
            <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
            
            <link rel="stylesheet" type="text/css" href="./libs/leaflet-freedraw.css" />
            <script src="./libs/leaflet-1.2.0/leaflet-src.js"></script>
            <script src="./libs/leaflet-freedraw.web.js"></script>
            
            <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
            <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
            <script src="./libs/jquery-3.2.1.min.js"></script>
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        
            <!-- user code -->
            <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
            <link rel="stylesheet" href="regionpicker.css" />
            </head>
            <body>
                <div class='container'>                
                    <div class='row'>
                        <div id="divCategory" class='dropdown'>
                            <label for="dropdownCategory">Category:</label>                
                            <select id="dropdownCategory" onchange=changeCategory()>
                            </select>
                        </div>
                        <div id="divRegion" class='dropdown'>
                            <label for="dropdownRegion">Region:</label>                      
                            <select id="dropdownRegion" onchange="changeRegion()">  
                            </select>
                        </div>
                        <div class='dropdown'><button onclick="ClickMe()">Click me</button></div>        
                    </div>
                </div>
                <div id="map"></div>
                <script>
                
                    const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
                    var regions = [];
                    var selectedPolygonRegion;
                    var geojsonLayer;
                    var bounds = L.latLngBounds([]);
        
                    // populate Category dropdown list
                    const categoryJSON = '{"ogp:BF_PROV_ELECTORAL_DIVISION":"Prov Electoral Division","ogp:BF_WILDERNESS_AREA_POLYGON":"Wilderness Area","ogp:BF_WILDFIRE_MGMT_POLYGON":"Wildfire MGMT","ogp:BF_TREATY_POLYGON":"TREATY"}';
                    const categoryNameFieldJSON = '{"ogp:BF_PROV_ELECTORAL_DIVISION":"edname","ogp:BF_WILDERNESS_AREA_POLYGON":"wildarea_n","ogp:BF_WILDFIRE_MGMT_POLYGON":"wma_name","ogp:BF_TREATY_POLYGON":"treaty_nam"}';
                    var category = $.parseJSON(categoryJSON);
                    var selectbox = $('#dropdownCategory');
                    selectbox.empty();
                    var list = '';
                    $.each(category, function(k, v) {
                        list += "<option value='" + k + "'>" + v + "</option>";                
                    });
                    selectbox.html(list);
        
                    const LAT_LNG = [53.554121, -113.491433];
                    var baseLayer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');	//base layer
        
                    map = new L.Map(document.querySelector('#map')).setView(LAT_LNG, 11);
                    map.addLayer(baseLayer);
        
                    // show the regions in first category
                    document.getElementById("dropdownCategory").selectedIndex = "-1";
                    //changeCategory();
        
        
                    function changeCategory(){
                        console.log("changeCategory fired");
                        var category = $("#dropdownCategory").val();
                        if (category){
                            load_wfs(category);
                        }                
                    }
        
                    function changeRegion(){
                        console.log("changeRegion fired");   
                        
                        if (geojsonLayer){
                            var categoryNameField = $.parseJSON(categoryNameFieldJSON);
                            var fieldName = categoryNameField[$("#dropdownCategory").val()];
                            geojsonLayer.eachLayer(function(layer){
                                if (eval("layer.feature.properties." + fieldName) == $("#dropdownRegion").val()) {
                                    if (selectedPolygonRegion) {
                                        // Reset selected to default style
                                        geojsonLayer.resetStyle(selectedPolygonRegion)
                                    }
        
                                    // Assign new selected
                                    selectedPolygonRegion = layer;
                                
                                    // Bring selected to front
                                    selectedPolygonRegion.bringToFront();
        
                                    // Style selected
                                    selectedPolygonRegion.setStyle({
                                        'color': 'blue', //'black' //'darkblue' //'red' //'blue' //'grey'
                                    });
                                
                                    // zoom to the region
                                    map.fitBounds(layer.getBounds());          
                                    
                                    outputString();
                                }               
                            });            
                        }
                    }
                    
                    // load wfs layer
                    function load_wfs(category){
                        // now call wfs service to get spatial data back
                        var geoJsonUrl = geoserverUrl + '/ogp/wfs';
                        var defaultParameters = {
                            service: 'WFS',
                            version: '2.0.0',
                            request: 'getFeature',
                            typeName: category,
                            maxFeatures: 300,
                            outputFormat: 'text/javascript',
                            srsName: 'EPSG:4326'
                        };
                        console.log(geoJsonUrl + L.Util.getParamString(L.Util.extend(defaultParameters)));
        
                        $.ajax({
                            url: geoJsonUrl + L.Util.getParamString(L.Util.extend(defaultParameters)),
                            dataType: 'jsonp',
                            jsonp:'format_options'
                        });
                    }
        
                    function parseResponse(data) {
                        console.log("Features: "+ data.features.length);
        
                        // remove previous loaded layer 
                        if (geojsonLayer && map.hasLayer(geojsonLayer)){
                                map.removeLayer(geojsonLayer);
                        }
        
                        regions = [];
                        //Zoom to layer            
                        L.geoJson(data, {
                            onEachFeature: onEachFeature
                        });
        
                        // Create new geojson layer to hightlight the polygon
                        geojsonLayer = new L.GeoJSON(data, {
                            // Set default style
                            'style': function () {
                                return {
                                    'color': 'grey',
                                    'weight': 2,
                                    'fillOpacity': 0.1,
                                }
                            }
        
                        //}).bindPopup(function (layer) {
                        //    return layer.feature.properties.edname;
                        }).on('click', function (e) {
                            highLight(e);
        
                            // change region list index
                            SelectRegion(e);
                            // output selected region
                            outputString();
                        }).addTo(map);
        
                        // once we've looped through all the features, zoom the map to the extent of the collection
                        map.fitBounds(bounds);
        
                        //update Regions dropdown list
                        var selectbox = $('#dropdownRegion');
                        selectbox.empty();
                        var list = '';
                        for (var i = 0; i < regions.length; i++) {
                            //list += '<option>' + regions[i] + '</option>';
                            list += "<option value='" + regions[i] + "'>" + regions[i] + "</option>";    
                        }
                        selectbox.html(list);
                        LogLayerCount();
                    }
                
                    function onEachFeature(feature, layer) {
                        // get the bounds of an individual feature
                        var layerBounds = layer.getBounds();
                        
                        // extend the bounds of the collection to fit the bounds of the new feature
                        bounds.extend(layerBounds);
        
                        // Add all feature name to dropdown control
                        var categoryNameField = $.parseJSON(categoryNameFieldJSON);
                        var fieldName = categoryNameField[$("#dropdownCategory").val()];
        
                        if (feature.properties && eval("feature.properties." + categoryNameField[$("#dropdownCategory").val()])) {
                            regions.push(eval("feature.properties." + categoryNameField[$("#dropdownCategory").val()]));   
                            console.log(eval("feature.properties." + categoryNameField[$("#dropdownCategory").val()]));             
                        };
                    }
        
                    function highLight(e){
                        // Check for selected
                        if (selectedPolygonRegion) {
                            // Reset selected to default style
                            e.target.resetStyle(selectedPolygonRegion)
                        }
                    
                        // Assign new selected
                        selectedPolygonRegion = e.layer;
        
                        // Bring selected to front
                        selectedPolygonRegion.bringToFront();
        
                        // Style selected
                        selectedPolygonRegion.setStyle({
                            'color': 'blue', //'black' //'darkblue' //'red' //'blue' //'grey'
                            /*
                            color: "#000",
                            fillColor: "#fff",
                            weight: 2,
                            opacity: 0.65
                            */              
                        })
                    }
                
                    function SelectRegion(e){
                        var categoryNameField = $.parseJSON(categoryNameFieldJSON);
                        var fieldName = categoryNameField[$("#dropdownCategory").val()];               
                        console.log(eval("e.layer.feature.properties." + fieldName));
                        $('#dropdownRegion').val(eval("e.layer.feature.properties." + fieldName));
                    }
        
                    function LogLayerCount(){
                    var i=0;
                    map.eachLayer(function (layer) {
                        i++;                
                        //console.log(i+": " );
                        //console.log(layer);
                    });
                    console.log("Layers on Maper: " + i);
                }
        
                function outputString(){
                    console.log("Spatial Coverage[Category:"+$("#dropdownCategory").val() + ",Region:"+$("#dropdownRegion").val()+"]");
                }
        
                function ClickMe(){
                    LogLayerCount();
                }
        
        
        
        
        
        
                </script>
            </body>
        </html>
        
        <!--  
            Add multiple WFS layers to Leaflet map from GeoServer using JQuery Ajax calls
            https://gis.stackexchange.com/questions/242358/add-multiple-wfs-layers-to-leaflet-map-from-geoserver-using-jquery-ajax-calls
        
            Add WFS layer (JSON) in Leaflet using Leaflet layer tree control
            https://gis.stackexchange.com/questions/189061/add-wfs-layer-json-in-leaflet-using-leaflet-layer-tree-control/189190
        
            about custom toolbar
            https://github.com/Leaflet/Leaflet.draw/issues/160
            https://github.com/Leaflet/Leaflet.draw/issues/48
            https://github.com/Leaflet/Leaflet.draw/issues/265
            https://wiki.documentfoundation.org/images/8/85/0401DG3-IntroducingDraw.pdf
            https://github.com/Leaflet/Leaflet.toolbar/blob/master/examples/subtoolbar.html
            https://github.com/leaflet/Leaflet.Toolbar/wiki/Building-custom-toolbars
            https://github.com/leaflet/Leaflet.Toolbar/wiki/API-Reference
            https://github.com/justinmanley/leaflet-draw-toolbar/blob/master/examples/combined.html
            https://github.com/Leaflet/Leaflet.toolbar/blob/master/examples/minimal.html
            https://getbounds.com/blog/a-modern-leaflet-toolbar/
            https://github.com/stefanocudini/leaflet-search
        
        -->
------------------------------------------ 2017-12-05 ------------------------------------------
docsonmap.html
        <html>
                
                <head>
                    <title>Geospatial Search</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
                    <link rel="stylesheet" href="./libs/leaflet-1.2.0/leaflet.css" />
                    <script src="./libs/leaflet-1.2.0/leaflet.js"></script>
                    <script src="./libs/leaflet-1.2.0/leaflet-src.js"></script>
                
                    <!-- easy button lib -->
                    <link rel="stylesheet" href="./libs/easy-button.css" />
                    <script src="./libs/easy-button.js"></script>
                
                    <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
                    <script src="./libs/esri-leaflet-v2.1.1/esri-leaflet.js"></script>
                    <script src="./libs/jquery.js"></script>
                
                    <!-- user code -->
                    <link rel="shortcut icon" type="image/x-icon" href="./images/favicon.ico" />
                </head>
                
                <body>
                    <div id="divbtn"><button id="btn1">clickme</button>
                        <div style="width: 100%; height: 100%; " id="map"></div>
                        <script>
                            var map = L.map('map', { scrollWheelZoom: false }).setView([37.8, -96], 4);
                            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                            L.easyButton('<img alt="do this" src="./libs/images/drawrectangle.png"/>', function () {
                                alert('you just clicked the html entity \&starf;');
                            }).addTo(map);
                
                            L.easyButton('<img alt="do this" src="./libs/images/byregion.png"/>', function () {
                                alert('you just clicked the html entity \&starf;');
                            }).addTo(map);
                
                            L.easyButton('<img alt="do this" src="./libs/images/drawpolygon.png"/>', function () {
                                alert('you just clicked the html entity \&starf;');
                            }).addTo(map);
                
                            $("#btn1").on("click", function () {
                                if (map.scrollWheelZoom.enabled()) {
                                    map.scrollWheelZoom.disable();
                                }
                                else {
                                    map.scrollWheelZoom.enable();
                                }
                
                            });
                
                            var ourCustomControl = L.Control.extend({
                
                                options: {
                                    position: 'topleft'
                                    //control position - allowed: 'topleft', 'topright', 'bottomleft', 'bottomright'
                                },
                
                                onAdd: function (map) {
                                    var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                
                                    container.style.backgroundColor = 'white';
                                    container.style.width = '30px';
                                    container.style.height = '30px';
                
                                    container.onclick = function () {
                                        console.log('buttonClicked');
                                    }
                                    return container;
                                }
                
                            });
                
                            map.addControl(new customControl());
                        </script>
                </body>
                
                </html>
                
                <!-- 
                Links: 
                    EasyButton v1 Examples:
                    http://danielmontague.com/projects/easyButton.js/v1/examples/
                    https://github.com/cliffcloud/Leaflet.EasyButton
                
                
                
                -->    
---------------------------------------- 2017-12-07  ------------------------
docsonmap.js
'use strict';

// prepare base layers
var baseLayerGroup = {
    "Topographic": L.esri.basemapLayer("Topographic"),
    "Streets": L.esri.basemapLayer("Streets"),
    "NationalGeographic": L.esri.basemapLayer("NationalGeographic"),
    "Oceans": L.esri.basemapLayer("Oceans"),
    "Gray": L.esri.basemapLayer("Gray"),
    "ShadedRelief": L.esri.basemapLayer("ShadedRelief"),
    "DarkGray": L.esri.basemapLayer("DarkGray"),
    "Imagery": L.esri.basemapLayer("Imagery"),
    "GrayLabels": L.esri.basemapLayer("GrayLabels"),
    "ImageryLabels": L.esri.basemapLayer("ImageryLabels"),
};

const geoserverUrl = 'http://172.23.37.69:8080/geoserver';
const docWFSName = 'ogp:BF_CULTURE_POINT';
const regionLayer = 'ogp:BF_PROV_ELECTORAL_DIVISION';
const nameField = 'edname'; 'fishmgmt_n'; // 
var map;
var paras;
var docLayer;
var regionLayerLayer;

var customLayer;
var selectRegion;
var regionArr = [];
var polygonArray = [];
var polygonLayer;
var markerArr = [];
var bounds = L.latLngBounds([]);

function replaceAll(str, find, replace) {
    var $r = "";
    while ($r != str) {
        $r = str;
        str = str.replace(find, replace);
    }
    return str;
}

function encodePara(para) {
    var strRet = para
    strRet = replaceAll(strRet, ')', '%29');
    strRet = replaceAll(strRet, ' ', '%20');
    strRet = replaceAll(strRet, ',', '%2C');
    strRet = replaceAll(strRet, '/', '%2F');
    strRet = replaceAll(strRet, ':', '%3A');
    strRet = replaceAll(strRet, '(', '%28');
    strRet = replaceAll(strRet, ')', '%29');
    return strRet;
}

function composeUrlString() {
    var requestUrl;
    // check workspace
    if (paras.workspace) {
        requestUrl = geoserverUrl;
        requestUrl += '/' + encodePara(paras.workspace) + '/wfs?service=WFS';
    } else {
        alert("Workspace in GeoServer must be specified.")
        return
    }

    // check version
    if (paras.version) {
        requestUrl += '&version=' + encodePara(paras.version);
    } else {
        alert("Version of WFS service must be specified.")
        return
    }

    // check request
    if (paras.request) {
        requestUrl += '&request=' + encodePara(paras.request);
    } else {
        alert("Request (getFeature, getMap... )must be specified.")
        return
    }

    // check feature layer
    if (paras.typename) {
        requestUrl += '&typeName=' + encodePara(paras.typename);
    } else {
        alert("typeName must be specified.")
        return
    }

    // check maxFeatures
    if (paras.maxfeatures) {
        requestUrl += '&maxFeatures=' + encodePara(paras.maxfeatures);
    }

    // check outputFormat
    if (paras.outputformat) {
        requestUrl += '&outputFormat=' + encodePara(paras.outputformat);
    }

    // check srsName
    if (paras.srsname) {
        requestUrl += '&srsName=' + encodePara(paras.srsname);
    }

    // check bbox
    if (paras.bbox) {
        requestUrl += '&bbox=' + encodePara(BoundingBox());
    }

    // check cql_filter
    if (paras.cqlfilter) {
        requestUrl += '&cql_filter=' + encodePara(paras.cqlfilter);
        //console.log(encodePara(paras.cqlfilter));                                                
    }

    // check cql_filter
    if (paras.sortBy) {
        requestUrl += '&sortBy=' + encodePara(paras.sortBy);
        //console.log(encodePara(paras.cqlfilter));                                                
    }
    console.log("requestUrl: " + requestUrl);
    return requestUrl;
}

// Compose the paras object before call
function load_wfs() {
    console.log(composeUrlString())
    $.ajax({
        url: composeUrlString(),
        dataType: 'jsonp'
    });
}

// Call back function: will use the default 'parseResponse' instead of : formatOptions = '&format_options=callback:testme'
function parseResponse(data) {
    // for document layers
    if (paras.layertype == '0') {
        if (docLayer && map.hasLayer(docLayer)) {
            map.removeLayer(docLayer);
            console.log("Doc Layer Removed, "+layerCount(true));
        }
        docLayer = L.geoJson(data, {
            onEachFeature: onEachDocFeature,
            //pointToLayer: function (feature, latlng) {
            //    return L.circleMarker(latlng, geojsonMarkerOptions);
            //}
        });
        docLayer.addTo(map);
        docLayer.bringToFront();
    } else if (paras.layertype == '1') {
        // for region layers
        regionLayerLayer = L.geoJson(data, {
            onEachFeature: onEachRegionFeature
        });

        //update innerHtml of divRegions
        var divRegions = document.getElementById("regions");
        var str = ''
        for (var i = 0; i < regionArr.length; i++) {
            str += '<option>' + regionArr[i] + '</option>';
        }
        divRegions.innerHTML = '<select id="regions">' + str + '</select>';
        $("#regions").on('change', function () {
            // changeRegion();
        });

    } else {
        console.log("Unhandled layer.");
    }
}

function removeLayer(layer){
    if (layer && map.hasLayer(layer)) {
        map.removeLayer(layer);
        console.log("Layer Removed from map: ");
        console.log(layer);
    }
}

function changeRegion() {
    if (regionLayerLayer) {
        regionLayerLayer.eachLayer(function (layer) {
            if (eval("layer.feature.properties.edname") == $("#regions").val()) {
                console.log(layer);
                if (layer["feature"]["geometry"]["type"] == 'Polygon') {

                    // deal with polygon
                    polygonArray = layer["feature"]["geometry"]["coordinates"][0];
                    polygonArray = flipCoords(polygonArray);

                } else if (layer["feature"]["geometry"]["type"] == 'MultiPolygon'){
                    console.log(layer["feature"]["geometry"]["coordinates"][0]);
                    polygonArray = layer["feature"]["geometry"]["coordinates"][0][0];
                    polygonArray = flipCoords(polygonArray);
                }
                console.log("polygonArray:" + polygonArray);
                //console.log(polygonArray[0]);
                //polygonArray = [[53.648048, -113.674737],[53.642571, -113.328298],[53.429471, -113.321369],[53.432223, -113.696100],[53.648048, -113.674737]];
                polygonLayer = L.polygon(polygonArray, { color: 'blue' });
                map.addLayer(polygonLayer);
                map.fitBounds(polygonLayer.getBounds());

                // query against polygon
                // load document layer
                paras = {
                    workspace: "ogp",
                    version: "2.0.0",
                    request: "getFeature",
                    typename: docWFSName,
                    layertype: '0',  //document layer
                    maxfeatures: '300',
                    outputformat: 'text/javascript',
                    cqlfilter: getCqlFilter(polygonArray)
                }
                load_wfs();
            }
        });
    }
    layerCount();
}

// return format: cqlfilter: 'intersects(point_geom,POLYGON((53.211133 -113.807376,53.211133 -113.388068,53.818406 -113.388068,53.818406 -113.807376,53.211133 -113.807376)))',            
function getCqlFilter(coords) {
    var strRet = '';

    $.each(coords, function (index, value) {
        strRet += value.join(' ') + ",";
    });
    strRet = "intersects(geom,POLYGON((" + strRet.slice(0, -1) + ")))";
    //strRet = "intersects(point_geom,POLYGON((" + "53.648048 -113.674737,53.642571 -113.328298,53.429471 -113.321369,53.432223 -113.696100,53.648048 -113.674737" + ")))";
    return strRet;
}

// Geoserver added [longitude, latitude] format, so have to flop coords
function flipCoords(arr) {
    var arrFliped = [];
    $.each(arr, function (index, value) {
        arrFliped.push(value.reverse());
    });
    return arrFliped;
}

function onEachDocFeature(feature, layer) {
    if (feature.properties && feature.properties.title) {
        layer.bindPopup(feature.properties.title);
    }
}

function onEachRegionFeature(feature, layer) {
    // Add all feature name to dropdown control
    if (feature.properties && feature.properties.edname) {
        regionArr.push(feature.properties.edname);
    };
}

function BoundingBox() {
    var bounds = map.getBounds().getSouthWest().lat + "," + map.getBounds().getSouthWest().lng + "," + map.getBounds().getNorthEast().lat + "," + map.getBounds().getNorthEast().lng;
    return bounds;
}

function layerCount(numOnly) {
    var iCount = 0;
    map.eachLayer(function (layer) {
        iCount++;
        if (!numOnly) {
            console.log("#" + iCount);
            console.log(layer);
        }
    });
    if (numOnly) {
        console.log("Num of Layer on Map:" + iCount);
    }
    return iCount;
}

function drawpolygon(button, map) {
    console.log("drawpolygon:");
    //var arr = [[54.7478,-110.0057],[53.8895,-110.0056],[53.8894,-110.1542],[53.8752,-110.1541],[53.8751,-110.2599],[53.8319,-110.26],[53.8319,-110.2689],[53.8224,-110.2689],[53.8224,-110.3581],[53.8299,-110.3581],[53.8319,-110.3543],[53.8319,-110.4355],[53.8922,-110.4356],[53.8922,-110.5172],[54.0132,-110.5174],[54.0133,-110.4507],[54.0641,-110.4507],[54.064,-111.2153],[54.1951,-111.2156],[54.1949,-111.3033],[54.2387,-111.3035],[54.2387,-111.3158],[54.326,-111.3159],[54.3259,-111.3286],[54.3333,-111.3286],[54.3333,-111.3909],[54.4247,-111.392],[54.4233,-111.41],[54.4252,-111.4163],[54.4231,-111.4237],[54.4259,-111.429],[54.4287,-111.4273],[54.4274,-111.4234],[54.4283,-111.4251],[54.4296,-111.4241],[54.4309,-111.4251],[54.4339,-111.4317],[54.4371,-111.4327],[54.4394,-111.4424],[54.6024,-111.4426],[54.6024,-111.3166],[54.6606,-111.3166],[54.6606,-111.2411],[54.7623,-111.2411],[54.7623,-110.0814],[54.7479,-110.0813],[54.7479,-110.0561],[54.7407,-110.0561],[54.7406,-110.0309],[54.7479,-110.0309],[54.7478,-110.0057]];
    //var arr = [[51.0088,-114.1389],[51.0017,-114.1295],[50.998,-114.107],[50.9944,-114.0966],[50.9942,-114.0715],[50.965,-114.0716],[50.9615,-114.0952],[50.9505,-114.0948],[50.9505,-114.1413],[50.9797,-114.1413],[50.9844,-114.1533],[50.9848,-114.1642],[50.9968,-114.1642],[50.9982,-114.1572],[50.9941,-114.1413],[51.009,-114.1413],[51.0088,-114.1389]];    
    var arr = [[51.1252,-113.9117],[51.1252,-113.9466],[51.1106,-113.947],[51.1106,-113.9351],[51.0961,-113.9351],[51.0958,-113.9817],[51.1835,-113.9817],[51.1835,-113.9117],[51.1252,-113.9117]];
    var polygon= L.polygon(arr, { color: 'red' });
    map.addLayer(polygon);
    map.fitBounds(polygon.getBounds());
/*
    var markers = [
        [ 51.1252,-113.9117, "1" ],
        [ 51.1252,-113.9466, "2" ],
        [ 51.1106,-113.947, "3" ],
        [ 51.1106,-113.9351, "4" ],
        [ 51.0961,-113.9351, "5" ],
        [ 51.0958,-113.9817, "6" ],
        [ 51.1835,-113.9817, "7" ],
        [ 51.1835,-113.9117, "8" ],
        [ 51.1252,-113.9117, "9" ]
     ];
     
     //Loop through the markers array
     for (var i=0; i<markers.length; i++) {
       
        var lon = markers[i][1];
        var lat = markers[i][0];
        var popupText = markers[i][2];
        
         var markerLocation = new L.LatLng(lat, lon);
         console.log(markerLocation);
         var marker = new L.Marker(markerLocation);
         map.addLayer(marker);
     
         marker.bindPopup(popupText);
     
     }
*/
//var marker = L.marker([51.1252,-113.9117]).addTo(map);

}

function drawrectangle(button, map) {
    map.on('click', addMarker);
    
            function addMarker(e) {
                // Add marker to map at click location; add popup window
                var newMarker = new L.marker(e.latlng).addTo(map);
                console.log(e.latlng);
            }
}

function showHide(obj) {
    var div = document.getElementById(obj);
    if (div.style.display == 'none') {
        div.style.display = '';
    }
    else {
        div.style.display = 'none';
    }
}

function Test(){
    console.log("Test Clicked");
}

$(document).ready(function () {

    // load map object
    map = L.map('map', {
        center: [53.554121, -113.491433],
        zoom: 10
    });

    var baselayer = baseLayerGroup.Topographic;
    map.addLayer(baselayer);

    L.control.layers(baseLayerGroup).addTo(map);

    L.easyButton({
        id: 'id-drawpolygon',
        position: 'topleft',
        type: 'replace',
        leafletClasses: true,
        states: [{
            stateName: 'draw-polygon',
            onClick: function (button, map) {
                drawpolygon(button, map);
            },
            title: 'Search Doc inside polygon',
            icon: '<img alt="draw polygon" src="./libs/images/drawpolygon.png"/>'
        }]
    }).addTo(map);

    L.easyButton({
        id: 'id-drawrectangle',
        position: 'topleft',
        type: 'replace',
        leafletClasses: true,
        states: [{
            stateName: 'draw-rectangle',
            onClick: function (button, map) {
                drawrectangle(button, map);
            },
            title: 'Search Doc inside rectangle',
            icon: '<img alt="draw rectangle" src="./libs/images/drawrectangle.png"/>'
        }]
    }).addTo(map);

    var regionsElm = L.control({ position: 'topleft' });
    regionsElm.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'regions');
        div.innerHTML = '<select id="regions"></select>';
        div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
        return div;
    };
    regionsElm.addTo(map);

    // load  regions
    paras = {
        workspace: "ogp",
        version: "2.0.0",
        request: "getFeature",
        typename: regionLayer,
        layertype: '1',  //Region layer 
        maxfeatures: '300',
        outputformat: 'text/javascript',
        sortBy: 'edname'
    }
    load_wfs();


});


